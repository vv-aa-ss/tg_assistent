"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞.
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ –∏–∑ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- openai: –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ —á–µ—Ä–µ–∑ OpenAI Whisper API

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" –∏–ª–∏ "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" -> /stat_u
- "–∫–∞—Ä—Ç—ã", "–±–∞–ª–∞–Ω—Å", "–±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã" -> /stat_bk
- "–∫—Ä–∏–ø—Ç–∞", "–±–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç–∞" -> /stat_k
- "–æ–ø–µ—Ä–∞—Ü–∏—è", "–¥–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é", "–Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è" -> /add (—Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º –¥–∞–Ω–Ω—ã—Ö)
- "–æ–ø–µ—Ä–∞—Ü–∏—è", "–¥–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é", "–Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è" -> /add (—Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º –¥–∞–Ω–Ω—ã—Ö)
"""
import logging
import os
import sys
import tempfile
import re
import asyncio
import json
from typing import Optional, Dict, List, Any, Tuple
from aiogram import Bot
from aiogram.types import Message, Voice
from openai import OpenAI
from app.config import get_settings

logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞
_openai_client: Optional[OpenAI] = None


def get_openai_client() -> Optional[OpenAI]:
	"""
	–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç OpenAI –∫–ª–∏–µ–Ω—Ç.
	–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è.
	
	Returns:
		OpenAI –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ None, –µ—Å–ª–∏ API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
	"""
	global _openai_client
	
	if _openai_client is not None:
		return _openai_client
	
	try:
		settings = get_settings()
		if not settings.openai_api_key:
			logger.warning("‚ö†Ô∏è OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö")
			return None
		
		# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –º–µ–¥–ª–µ–Ω–Ω—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º
		# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è SSL handshake –∏ –æ–±—â–∏–π —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞
		import httpx
		timeout = httpx.Timeout(
			connect=30.0,  # –¢–∞–π–º–∞—É—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è SSL handshake)
			read=60.0,     # –¢–∞–π–º–∞—É—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
			write=30.0,    # –¢–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–∞
			pool=30.0      # –¢–∞–π–º–∞—É—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–∑ –ø—É–ª–∞
		)
		
		_openai_client = OpenAI(
			api_key=settings.openai_api_key,
			base_url=settings.openai_base_url,
			timeout=timeout,
			max_retries=3  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
		)
		logger.info("‚úÖ OpenAI –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏")
		return _openai_client
	except Exception as e:
		logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI –∫–ª–∏–µ–Ω—Ç–∞: {e}")
		return None


async def download_voice_file(bot: Bot, voice: Voice) -> Optional[str]:
	"""
	–°–∫–∞—á–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π —Ñ–∞–π–ª —Å —Å–µ—Ä–≤–µ—Ä–æ–≤ Telegram –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª.
	
	Args:
		bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
		voice: –û–±—ä–µ–∫—Ç Voice –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
		
	Returns:
		–ü—É—Ç—å –∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
	"""
	try:
		file = await bot.get_file(voice.file_id)
		file_path = file.file_path
		
		# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
		temp_dir = tempfile.gettempdir()
		temp_file = os.path.join(temp_dir, f"voice_{voice.file_id}.ogg")
		
		# –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
		await bot.download_file(file_path, destination=temp_file)
		logger.info(f"‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–π —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω: {temp_file}")
		
		return temp_file
	except Exception as e:
		logger.exception(f"‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞: {e}")
		return None


async def correct_recognition_errors(text: str, db) -> str:
	"""
	–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏.
	
	–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–æ–≤–∞—Ä—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–º–µ–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤
	–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.
	
	Args:
		text: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
		db: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
		
	Returns:
		–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
	"""
	# –ü–æ–ª—É—á–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
	corrections = await db.get_voice_corrections()
	
	# –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Å —É—á–µ—Ç–æ–º –≥—Ä–∞–Ω–∏—Ü —Å–ª–æ–≤, —á—Ç–æ–±—ã –Ω–µ –∑–∞–º–µ–Ω—è—Ç—å —á–∞—Å—Ç–∏ –¥—Ä—É–≥–∏—Ö —Å–ª–æ–≤)
	corrected_text = text
	for wrong, correct in corrections.items():
		# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å —É—á–µ—Ç–æ–º –≥—Ä–∞–Ω–∏—Ü —Å–ª–æ–≤
		# –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ "–∫–æ–≤–∞–ª—å" –∑–∞–º–µ–Ω–∏—Ç—Å—è, –Ω–æ "–∫–æ–≤–∞–ª—å—Å–∫–∏–π" –Ω–µ –∑–∞—Ç—Ä–æ–Ω–µ—Ç—Å—è
		pattern = r'\b' + re.escape(wrong) + r'\b'
		before = corrected_text
		corrected_text = re.sub(pattern, correct, corrected_text, flags=re.IGNORECASE)
		if before != corrected_text:
			logger.debug(f"üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ: '{wrong}' -> '{correct}' –≤ —Ç–µ–∫—Å—Ç–µ '{before}' -> '{corrected_text}'")
	
	if corrected_text != text:
		logger.debug(f"üîß –ò—Ç–æ–≥–æ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: '{text}' -> '{corrected_text}'")
	
	return corrected_text


async def transcribe_voice(bot: Bot, voice: Voice, db=None) -> Optional[str]:
	"""
	–†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ä–µ—á—å –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç.
	–ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI Whisper API –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.
	
	Args:
		bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
		voice: –û–±—ä–µ–∫—Ç Voice –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
		db: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è)
		
	Returns:
		–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
	"""
	voice_file = None
	
	try:
		# –ü–æ–ª—É—á–∞–µ–º OpenAI –∫–ª–∏–µ–Ω—Ç
		openai_client = get_openai_client()
		if not openai_client:
			logger.error("‚ùå OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
			return None
		
		# –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
		voice_file = await download_voice_file(bot, voice)
		if not voice_file:
			return None
		
		logger.info(f"üé§ –û—Ç–ø—Ä–∞–≤–ª—è—é –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ OpenAI Whisper API...")
		
		# Whisper API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç OGG —Ñ–æ—Ä–º–∞—Ç –Ω–∞–ø—Ä—è–º—É—é, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
		audio_file_path = voice_file
		
		# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ OpenAI Whisper API
		max_retries = 3
		for attempt in range(max_retries):
			try:
				with open(audio_file_path, "rb") as audio_file:
					transcript = openai_client.audio.transcriptions.create(
						model="whisper-1",
						file=audio_file,
						language="ru"
					)
				
				text = transcript.text
				logger.info(f"‚úÖ OpenAI Whisper —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —Ç–µ–∫—Å—Ç: {text}")
				
				# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
				if db:
					text = await correct_recognition_errors(text, db)
				
				return text.lower().strip()
				
			except Exception as e:
				error_msg = str(e)
				# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –¥–ª—è –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
				if "timeout" in error_msg.lower() or "timed out" in error_msg.lower():
					error_type = "—Ç–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
				elif "connect" in error_msg.lower():
					error_type = "–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
				else:
					error_type = "–æ—à–∏–±–∫–∞ API"
				
				if attempt < max_retries - 1:
					logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ —Ä–µ—á–∏ (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}): {error_type} - {error_msg}. –ü–æ–≤—Ç–æ—Ä—è—é...")
					# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
					await asyncio.sleep(2 * (attempt + 1))  # 2, 4, 6 —Å–µ–∫—É–Ω–¥
					continue
				else:
					logger.error(f"‚ùå –û—à–∏–±–∫–∞ OpenAI Whisper API –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫ ({error_type}): {error_msg}")
					return None
		
	except Exception as e:
		logger.exception(f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏: {e}")
		return None
	finally:
		# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π OGG —Ñ–∞–π–ª
		if voice_file and os.path.exists(voice_file):
			try:
				os.remove(voice_file)
				logger.debug(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: {voice_file}")
			except Exception as e:
				logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª {voice_file}: {e}")


def parse_voice_command(text: str) -> Optional[str]:
	"""
	–ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫—É—é –∫–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å.
	
	Args:
		text: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
		
	Returns:
		–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (stat_u, stat_k, stat_bk, add, move) –∏–ª–∏ None
	"""
	if not text:
		return None
	
	text = text.lower().strip()
	
	# –ö–æ–º–∞–Ω–¥–∞ /move: "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏", "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å", "move" + –¥–≤–µ –∫–∞—Ä—Ç—ã (—Å –∫–∞—Ä—Ç—ã –Ω–∞ –∫–∞—Ä—Ç—É)
	move_keywords = [
		"–ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å –∫–∞—Ä—Ç—ã", "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–æ –∫–∞—Ä—Ç—ã", "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –æ—Ç –∫–∞—Ä—Ç—ã",
		"–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Å –∫–∞—Ä—Ç—ã", "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Å–æ –∫–∞—Ä—Ç—ã", "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –æ—Ç –∫–∞—Ä—Ç—ã",
		"–ø–µ—Ä–µ–≤–æ–¥ —Å –∫–∞—Ä—Ç—ã", "–ø–µ—Ä–µ–≤–æ–¥ —Å–æ –∫–∞—Ä—Ç—ã", "–ø–µ—Ä–µ–≤–æ–¥ –æ—Ç –∫–∞—Ä—Ç—ã",
		"move", "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏", "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å"
	]
	# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–≤—É—Ö –∫–∞—Ä—Ç –≤ —Ç–µ–∫—Å—Ç–µ (–µ—Å—Ç—å "—Å –∫–∞—Ä—Ç—ã" –∏ "–Ω–∞ –∫–∞—Ä—Ç—É")
	has_card_from = any(kw in text for kw in ["—Å –∫–∞—Ä—Ç—ã", "—Å–æ –∫–∞—Ä—Ç—ã", "–æ—Ç –∫–∞—Ä—Ç—ã", "—Å –∫–∞—Ä—Ç–∞", "—Å–æ –∫–∞—Ä—Ç–∞"])
	has_card_to = any(kw in text for kw in ["–Ω–∞ –∫–∞—Ä—Ç—É", "–≤ –∫–∞—Ä—Ç—É", "–Ω–∞ –∫–∞—Ä—Ç–∞", "–≤ –∫–∞—Ä—Ç–∞"])
	if any(keyword in text for keyword in move_keywords) and (has_card_from or has_card_to):
		return "move"
	
	# –ö–æ–º–∞–Ω–¥–∞ /add: "–æ–ø–µ—Ä–∞—Ü–∏—è", "–¥–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é", "–Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è" (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ü–ï–†–í–û–ô, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞)
	# –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å "–æ–ø–µ—Ä–∞—Ü–∏—è", —ç—Ç–æ —Ç–æ—á–Ω–æ –∫–æ–º–∞–Ω–¥–∞ /add, –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–ª–æ–≤–∞ "–∫–∞—Ä—Ç–∞", "–∫—Ä–∏–ø—Ç–∞" –∏ —Ç.–¥.
	add_keywords = [
		"–æ–ø–µ—Ä–∞—Ü–∏—è", "–¥–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é", "–Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è", "add operation",
		"–∑–∞–ø–∏—Å–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é", "–∑–∞–ø–∏—Å–∞—Ç—å", "–¥–æ–±–∞–≤–∏—Ç—å", "–æ–ø–µ—Ä–∞—Ü–∏—é"
	]
	if any(keyword in text for keyword in add_keywords):
		return "add"
	
	# –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –∫—Ä–∏–ø—Ç–∞/–∫–∞—Ä—Ç–∞/–Ω–∞–ª–∏—á–Ω—ã–µ —Å —á–∏—Å–ª–∞–º–∏ - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—è
	# –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã: –∫—Ä–∏–ø—Ç–∞ + —á–∏—Å–ª–æ, –∫–∞—Ä—Ç–∞ + —á–∏—Å–ª–æ, –Ω–∞–ª–∏—á–Ω—ã–µ + —á–∏—Å–ª–æ
	has_crypto_with_number = any(kw in text for kw in [
		"–±–∏—Ç–æ–∫", "–±–∏—Ç–∫–∞", "–±–∏—Ç–∫–æ–∏–Ω", "–±–∏—Ç–∫–æ–∏–Ω–∞", "–±—Ç—Ü", "bitcoin", "btc",
		"–ª–∞–π—Ç–∫–æ–∏–Ω", "–ª–∞–π—Ç–∫–æ–∏–Ω–∞", "litecoin", "ltc", "–ª—Ç–∫", "ltk",
		"–º–æ–Ω–µ—Ä–æ", "–º–æ–Ω–µ—Ä–æ", "monero", "xmr", "–º–∞–Ω–µ—Ä–∞", "–º–∞–Ω–µ—Ä—ã",
		"—Ç–µ–∑–µ—Ä", "tez", "—é—Å–¥—Ç", "usdt", "tether"
	]) and bool(re.search(r'\d+', text))
	has_card_with_number = any(kw in text for kw in ["–∫–∞—Ä—Ç–∞", "–∫–∞—Ä—Ç—É", "–∫–∞—Ä—Ç—ã", "card", "cards", "–ø–µ—Ä–µ–≤–µ–ª–∏ –Ω–∞ –∫–∞—Ä—Ç—É", "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—É"]) and bool(re.search(r'\d+', text))
	has_cash_with_number = any(kw in text for kw in ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash", "–±–µ–ª–∫–∏", "–±–∞–∫—Å—ã", "–±–∞–∫—Å–æ–≤", "—é—Å–¥", "usd", "–¥–æ–ª–ª–∞—Ä–æ–≤", "–¥–æ–ª–ª–∞—Ä—ã", "–¥–æ–ª–ª–∞—Ä"]) and bool(re.search(r'\d+', text))
	
	# –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –¥–≤–∞ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö —Å —á–∏—Å–ª–∞–º–∏, —ç—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏—è
	if (has_crypto_with_number and (has_card_with_number or has_cash_with_number)) or (has_card_with_number and has_cash_with_number):
		return "add"
	
	# –ö–æ–º–∞–Ω–¥–∞ /stat_k: "–∫—Ä–∏–ø—Ç–∞", "–±–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç–∞", "crypto" (–ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ç–æ—Ä—ã–º, —Ç–∞–∫ –∫–∞–∫ –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ)
	crypto_keywords = [
		"–±–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç–∞", "–±–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç—ã", "–±–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç",
		"–∫—Ä–∏–ø—Ç–∞", "–∫—Ä–∏–ø—Ç—ã", "–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç", "–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞",
		"crypto", "cryptocurrency", "–±–∞–ª–∞–Ω—Å crypto", "–±–∞–ª–∞–Ω—Å cryptocurrency"
	]
	if any(keyword in text for keyword in crypto_keywords):
		return "stat_k"
	
	# –ö–æ–º–∞–Ω–¥–∞ /stat_bk: "–∫–∞—Ä—Ç—ã", "–±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã", "–±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç"
	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ –æ–ø–µ—Ä–∞—Ü–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å "–æ–ø–µ—Ä–∞—Ü–∏—è", —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ "add" –≤—ã—à–µ)
	card_keywords = ["–±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã", "–±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç", "–∫–∞—Ä—Ç—ã", "–∫–∞—Ä—Ç–∞", "cards", "–±–∞–ª–∞–Ω—Å cards"]
	if any(keyword in text for keyword in card_keywords):
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ –∫—Ä–∏–ø—Ç—É (–Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)
		if "–∫—Ä–∏–ø—Ç" not in text and "crypto" not in text:
			return "stat_bk"
	
	# –ö–æ–º–∞–Ω–¥–∞ /stat_u: "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" –∏–ª–∏ "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
	stats_keywords = ["—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "statistics", "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ users"]
	if any(keyword in text for keyword in stats_keywords):
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ –∫–∞—Ä—Ç—ã –∏–ª–∏ –∫—Ä–∏–ø—Ç—É (–Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)
		if "–∫–∞—Ä—Ç" not in text and "–∫—Ä–∏–ø—Ç" not in text and "crypto" not in text and "card" not in text:
			return "stat_u"
	
	return None


async def get_database_context(db) -> str:
	"""
	–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ GPT.
	–í–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–∞—Ö, –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞—Ö –∏ –Ω–∞–ª–∏—á–Ω—ã—Ö.
	–§–æ—Ä–º–∞—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π.
	
	Args:
		db: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
		
	Returns:
		–°—Ç—Ä–æ–∫–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ë–î
	"""
	if not db:
		return ""
	
	try:
		context_parts = []
		
		# –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—ã –∫–∞—Ä—Ç –∏ –∫–∞—Ä—Ç—ã - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
		groups = await db.list_card_groups()
		if groups:
			context_parts.append("=== –ö–ê–†–¢–´ ===")
			context_parts.append("–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–û —ç—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!")
			context_parts.append("")
			for group in groups:
				group_id = group.get("id")
				group_name = group.get("name", "")
				cards = await db.get_cards_by_group(group_id)
				if cards:
					card_list = []
					for card in cards:
						card_name = card[1]  # card[1] - —ç—Ç–æ name
						# –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—É —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –≥—Ä—É–ø–ø—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
						card_list.append(f'    - "{card_name}" (–≥—Ä—É–ø–ø–∞: "{group_name}")')
					cards_text = "\n".join(card_list)
					context_parts.append(f'–ì—Ä—É–ø–ø–∞ "{group_name}":')
					context_parts.append(cards_text)
					context_parts.append("")
		
		# –ö–∞—Ä—Ç—ã –±–µ–∑ –≥—Ä—É–ø–ø—ã
		cards_without_group = await db.get_cards_without_group()
		if cards_without_group:
			card_list = []
			for card in cards_without_group:
				card_name = card[1]
				card_list.append(f'    - "{card_name}"')
			cards_text = "\n".join(card_list)
			context_parts.append('–ë–µ–∑ –≥—Ä—É–ø–ø—ã:')
			context_parts.append(cards_text)
			context_parts.append("")
		
		# –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã
		crypto_columns = await db.list_crypto_columns()
		if crypto_columns:
			context_parts.append("=== –ö–†–ò–ü–¢–û–í–ê–õ–Æ–¢–´ ===")
			crypto_types = [crypto.get("crypto_type", "") for crypto in crypto_columns]
			for crypto_type in crypto_types:
				context_parts.append(f'  - "{crypto_type}"')
			context_parts.append("")
		
		# –ù–∞–ª–∏—á–Ω—ã–µ
		cash_columns = await db.list_cash_columns()
		if cash_columns:
			context_parts.append("=== –ù–ê–õ–ò–ß–ù–´–ï ===")
			for cash in cash_columns:
				display_name = cash.get("display_name", "") or cash.get("cash_name", "")
				cash_name = cash.get("cash_name", "")
				if display_name:
					context_parts.append(f'  - "{display_name}" (–∫–æ–¥: "{cash_name}")')
				else:
					context_parts.append(f'  - "{cash_name}"')
			context_parts.append("")
		
		return "\n".join(context_parts) if context_parts else ""
	except Exception as e:
		logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ë–î: {e}")
		return ""


async def validate_and_fix_gpt_response(parsed: Dict[str, Any], db) -> Dict[str, Any]:
	"""
	–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç GPT, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ –ë–î.
	
	Args:
		parsed: –û—Ç–≤–µ—Ç –æ—Ç GPT
		db: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
		
	Returns:
		–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏
	"""
	if not parsed or not db:
		return parsed
	
	if parsed.get("command") not in ["add", "move"] or not parsed.get("blocks"):
		return parsed
	
	try:
		# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã –∏ –∫–∞—Ä—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
		groups = await db.list_card_groups()
		all_groups_dict = {group["name"].upper(): group["name"] for group in groups}
		
		# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –±–ª–æ–∫
		for block in parsed["blocks"]:
			# –£–¥–∞–ª—è–µ–º –ø–æ–ª—è —Å null –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
			if "cash" in block:
				if not block["cash"] or (isinstance(block["cash"], dict) and not block["cash"].get("name")):
					logger.warning(f"‚ö†Ô∏è –£–¥–∞–ª—è–µ–º cash –∏–∑ –±–ª–æ–∫–∞: –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ")
					block.pop("cash")
			
			# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—ã –¥–ª—è –∫–æ–º–∞–Ω–¥—ã move (card_from –∏ card_to)
			if "card_from" in block and block["card_from"]:
				card_from_info = block["card_from"]
				group_name = card_from_info.get("group", "")
				card_name = card_from_info.get("name", "")
				card_result = await find_card_by_group_and_name(group_name, card_name, db)
				if card_result:
					card_from_info["name"] = card_result["card_name"]
					if card_result.get("group_id"):
						group_obj = await db.get_card_group_by_id(card_result["group_id"])
						if group_obj:
							card_from_info["group"] = group_obj["name"]
					logger.info(f"‚úÖ –ö–∞—Ä—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: '{card_name}' -> '{card_result['card_name']}'")
			
			if "card_to" in block and block["card_to"]:
				card_to_info = block["card_to"]
				group_name = card_to_info.get("group", "")
				card_name = card_to_info.get("name", "")
				card_result = await find_card_by_group_and_name(group_name, card_name, db)
				if card_result:
					card_to_info["name"] = card_result["card_name"]
					if card_result.get("group_id"):
						group_obj = await db.get_card_group_by_id(card_result["group_id"])
						if group_obj:
							card_to_info["group"] = group_obj["name"]
					logger.info(f"‚úÖ –ö–∞—Ä—Ç–∞-–ø–æ–ª—É—á–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: '{card_name}' -> '{card_result['card_name']}'")
			
			# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—ã –¥–ª—è –∫–æ–º–∞–Ω–¥—ã add
			if "card" in block:
				if not block["card"] or (isinstance(block["card"], dict) and not block["card"].get("name")):
					logger.warning(f"‚ö†Ô∏è –£–¥–∞–ª—è–µ–º card –∏–∑ –±–ª–æ–∫–∞: –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ")
					block.pop("card")
					continue
				
				if not isinstance(block["card"], dict):
					logger.warning(f"‚ö†Ô∏è –£–¥–∞–ª—è–µ–º card –∏–∑ –±–ª–æ–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö")
					block.pop("card")
					continue
				card_info = block["card"]
				group_name = card_info.get("group", "")
				card_name = card_info.get("name", "")
				
				# –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
				group_upper = group_name.upper()
				if group_upper in all_groups_dict:
					# –ì—Ä—É–ø–ø–∞ –Ω–∞–π–¥–µ–Ω–∞ —Ç–æ—á–Ω–æ
					correct_group = all_groups_dict[group_upper]
					card_info["group"] = correct_group
					logger.debug(f"‚úÖ –ì—Ä—É–ø–ø–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: '{group_name}' -> '{correct_group}'")
				
				# –ò—â–µ–º –ø–æ—Ö–æ–∂—É—é –≥—Ä—É–ø–ø—É –∏ –∫–∞—Ä—Ç—É
				card_result = await find_card_by_group_and_name(group_name, card_name, db)
				if card_result:
					# –ù–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–∞, –ø–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
					if card_result.get("group_id"):
						group_obj = await db.get_card_group_by_id(card_result["group_id"])
						if group_obj:
							correct_group = group_obj["name"]
							card_info["group"] = correct_group
							card_info["name"] = card_result["card_name"]
							logger.info(f"‚úÖ –ì—Ä—É–ø–ø–∞ –∏ –∫–∞—Ä—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã: '{group_name}' -> '{correct_group}', '{card_name}' -> '{card_result['card_name']}'")
					else:
						# –ö–∞—Ä—Ç–∞ –±–µ–∑ –≥—Ä—É–ø–ø—ã
						card_info["name"] = card_result["card_name"]
						card_info.pop("group", None)  # –£–±–∏—Ä–∞–µ–º –≥—Ä—É–ø–ø—É, –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ –±–µ–∑ –≥—Ä—É–ø–ø—ã
						logger.info(f"‚úÖ –ö–∞—Ä—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ (–±–µ–∑ –≥—Ä—É–ø–ø—ã): '{card_name}' -> '{card_result['card_name']}'")
				else:
					# –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ç–æ–ª—å–∫–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–∞—Ä—Ç—ã (–±–µ–∑ –≥—Ä—É–ø–ø—ã)
					card_result = await find_card_by_group_and_name("", card_name, db)
					if card_result:
						card_info["name"] = card_result["card_name"]
						if card_result.get("group_id"):
							group_obj = await db.get_card_group_by_id(card_result["group_id"])
							if group_obj:
								card_info["group"] = group_obj["name"]
						logger.info(f"‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: '{card_name}' -> '{card_result['card_name']}'")
		
		return parsed
	except Exception as e:
		logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ GPT: {e}")
		return parsed


async def parse_voice_with_gpt(text: str, db=None) -> Optional[Dict[str, Any]]:
	"""
	–ü–∞—Ä—Å–∏—Ç –≥–æ–ª–æ—Å–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ GPT –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
	
	Args:
		text: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
		db: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
		
	Returns:
		–°–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
	"""
	openai_client = get_openai_client()
	if not openai_client:
		logger.error("‚ùå OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
		return None
	
	# –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î
	db_context = await get_database_context(db)
	
	# –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
	system_prompt = """–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –±–æ—Ç–∞.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤–µ—Ä–Ω—É—Ç—å JSON.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- "add" - –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é)
- "move" - –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ (–ø–µ—Ä–µ–≤–æ–¥ —Å –∫–∞—Ä—Ç—ã –Ω–∞ –∫–∞—Ä—Ç—É)
- "stat_u" - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- "stat_bk" - –±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç
- "stat_k" - –±–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã "add":
{
  "command": "add",
  "blocks": [
    {
      "crypto": {"currency": "BTC", "usd_amount": 100},
      "card": {"group": "–ö–ê–í–ê–õ", "name": "–ë–µ–ª–í—ç–±", "amount": 360},
      "cash": {"name": "–±–µ–ª–∫–∏", "amount": 300}
    }
  ]
}

–ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:
- "–æ—Ç–ø—Ä–∞–≤–∏–ª –±–∏—Ç–∫–∞ –Ω–∞ 115 –¥–æ–ª–ª–∞—Ä–æ–≤, –Ω–∞ –∫–≤–ª–∞ –±–µ–ª–ª–≤–µ–± –ø–æ–ª–æ–∂–∏–ª–∏ 230 —Ä—É–±–ª–µ–π" -> 
  {"command": "add", "blocks": [{"crypto": {"currency": "BTC", "usd_amount": 115}, "card": {"group": "–ö–ê–í–ê–õ", "name": "–ë–µ–ª–í—ç–±", "amount": 230}}]}
- "–±–∏—Ç–∫–∞ 100 –±–∞–∫—Å–æ–≤, 230 —Ä—É–±–ª–µ–π –Ω–∞ –∫–≤–ª–∞ –±–µ–ª–ª–≤–µ–±" -> 
  {"command": "add", "blocks": [{"crypto": {"currency": "BTC", "usd_amount": 100}, "card": {"group": "–ö–ê–í–ê–õ", "name": "–ë–µ–ª–í—ç–±", "amount": 230}}]}
- "–Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞ 156 –¥–æ–ª–ª–∞—Ä–æ–≤ –≤ –±–∏—Ç–∫–æ–∏–Ω–µ, –Ω–∞ –∂–∞–Ω–Ω—É –±–µ–ª–æ–≤–∞ –ø–µ—Ä–µ–≤–µ–ª–∏ 200" -> 
  {"command": "add", "blocks": [{"crypto": {"currency": "BTC", "usd_amount": 156}, "card": {"group": "–ñ–ê–ù–ù–ê", "name": "–í–≠–ë –ñ", "amount": 200}}]}
- "–±–∏—Ç–∫–∞ 100, –Ω–∞–ª–∏—á–Ω—ã–µ 500 —Ä—É–±–ª–µ–π" -> 
  {"command": "add", "blocks": [{"crypto": {"currency": "BTC", "usd_amount": 100}, "cash": {"name": "—Ä—É–±", "amount": 500}}]}
- "–∑–∞–ø–∏—à–∏ –º–æ–Ω–µ—Ä–æ-2 300" –∏–ª–∏ "Monero 2.300" -> 
  {"command": "add", "blocks": [{"crypto": {"currency": "XMR", "xmr_number": 2, "usd_amount": 300}}]}
- "–º–∞–Ω–µ—Ä–∞ 1 500" -> 
  {"command": "add", "blocks": [{"crypto": {"currency": "XMR", "xmr_number": 1, "usd_amount": 500}}]}
- "–∂–∞–Ω–Ω–∞ —Å–±–µ—Ä –º–∏–Ω—É—Å 470 —Ä—É–±–ª–µ–π" -> 
  {"command": "add", "blocks": [{"card": {"group": "–ñ–ê–ù–ù–ê", "name": "–°–±–µ—Ä –ñ", "amount": -470}}]}
- "—Ç–µ–∑ —Ç—Ä–∞—Å—Ç –º–∏–Ω—É—Å 160" -> 
  {"command": "add", "blocks": [{"crypto": {"currency": "TEZ-TRUST", "usd_amount": -160}}]}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã "move" (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤):
{
  "command": "move",
  "blocks": [
    {
      "card": {"group": "–ö–ê–í–ê–õ", "name": "–ë–µ–ª–í—ç–±", "amount": 360}
    },
    {
      "card": {"group": "–ñ–ê–ù–ù–ê", "name": "–°–±–µ—Ä", "amount": 360}
    }
  ]
}
–ò–ª–∏ –æ–¥–∏–Ω –±–ª–æ–∫ —Å –¥–≤—É–º—è –∫–∞—Ä—Ç–∞–º–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –æ–±–µ):
{
  "command": "move",
  "blocks": [
    {
      "card_from": {"group": "–ö–ê–í–ê–õ", "name": "–ë–µ–ª–í—ç–±", "amount": 360},
      "card_to": {"group": "–ñ–ê–ù–ù–ê", "name": "–°–±–µ—Ä", "amount": 360}
    }
  ]
}

–í–ê–ñ–ù–û –æ —Ñ–æ—Ä–º–∞—Ç–µ:
- –ï—Å–ª–∏ –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö), –ù–ï –¥–æ–±–∞–≤–ª—è–π —ç—Ç–æ –ø–æ–ª–µ –≤ –±–ª–æ–∫
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π null –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (name, amount, currency –∏ —Ç.–¥.)
- –ï—Å–ª–∏ crypto –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ–ª–µ "crypto"
- –ï—Å–ª–∏ card –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ–ª–µ "card"
- –ï—Å–ª–∏ cash –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ–ª–µ "cash"
- xmr_number –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–ª—è XMR, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ (1, 2, 3), –∏–Ω–∞—á–µ –Ω–µ –¥–æ–±–∞–≤–ª—è–π —ç—Ç–æ –ø–æ–ª–µ

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥:
{
  "command": "stat_u" | "stat_bk" | "stat_k"
}

–ü—Ä–∞–≤–∏–ª–∞:
1. –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å–ª–æ–≤–∞ "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏", "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å", "move", "–ø–µ—Ä–µ–≤–æ–¥" + –¥–≤–µ –∫–∞—Ä—Ç—ã (–æ–¥–Ω–∞ "–æ—Ç–∫—É–¥–∞", –¥—Ä—É–≥–∞—è "–∫—É–¥–∞") - —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ "move"
   –ü—Ä–∏–º–µ—Ä—ã: "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å –∫–∞—Ä—Ç—ã –ö–ê–í–ê–õ –ë–µ–ª–í—ç–± –Ω–∞ –∫–∞—Ä—Ç—É –ñ–ê–ù–ù–ê –°–±–µ—Ä 360", "–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å 500 —Å –ö–ê–í–ê–õ –ë–µ–ª–í—ç–± –Ω–∞ –ñ–ê–ù–ù–ê –°–±–µ—Ä"
2. –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å–ª–æ–≤–∞ "–æ–ø–µ—Ä–∞—Ü–∏—è", "–¥–æ–±–∞–≤–∏—Ç—å", "–∑–∞–ø–∏—Å–∞—Ç—å" + –¥–∞–Ω–Ω—ã–µ (–∫—Ä–∏–ø—Ç–∞/–∫–∞—Ä—Ç–∞/–Ω–∞–ª–∏—á–Ω—ã–µ —Å —á–∏—Å–ª–∞–º–∏) - —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ "add"
   - –í–ê–ñ–ù–û: –í –∫–æ–º–∞–Ω–¥–µ "add" –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: –∫—Ä–∏–ø—Ç–∞, –∫–∞—Ä—Ç–∞, –Ω–∞–ª–∏—á–Ω—ã–µ - –≤—Å–µ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∏ –∫—Ä–∏–ø—Ç–∞, –∏ –∫–∞—Ä—Ç–∞ - –æ–±–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ
   - –ü—Ä–∏–º–µ—Ä: "–±–∏—Ç–∫–∞ 156, –Ω–∞ –∂–∞–Ω–Ω—É –±–µ–ª–æ–≤–∞ –ø–µ—Ä–µ–≤–µ–ª–∏ 200" -> {"command": "add", "blocks": [{"crypto": {"currency": "BTC", "usd_amount": 156}, "card": {"group": "–ñ–ê–ù–ù–ê", "name": "–í–≠–ë –ñ", "amount": 200}}]}
3. –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" - –∫–æ–º–∞–Ω–¥–∞ "stat_u"
4. –ï—Å–ª–∏ "–±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç" –∏–ª–∏ "–∫–∞—Ä—Ç—ã" - –∫–æ–º–∞–Ω–¥–∞ "stat_bk"
5. –ï—Å–ª–∏ "–±–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç–∞" –∏–ª–∏ "–∫—Ä–∏–ø—Ç–∞" - –∫–æ–º–∞–Ω–¥–∞ "stat_k"
6. –î–ª—è –∫—Ä–∏–ø—Ç—ã: currency –º–æ–∂–µ—Ç –±—ã—Ç—å BTC, LTC, XMR, USDT, TEZ, TEZ_TRUST. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è XMR (1, 2, 3), –∏—Å–ø–æ–ª—å–∑—É–π xmr_number.
   - –í–ê–ñ–ù–û –¥–ª—è XMR: –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å "Monero 2.300", "–º–æ–Ω–µ—Ä–æ 2.300", "–º–∞–Ω–µ—Ä–∞ 2.300" - —ç—Ç–æ XMR-2 —Å —Å—É–º–º–æ–π 300, –∞ –ù–ï XMR —Å —Å—É–º–º–æ–π 2.3!
   - –ï—Å–ª–∏ –ø–æ—Å–ª–µ "Monero"/"–º–æ–Ω–µ—Ä–æ"/"–º–∞–Ω–µ—Ä–∞" –∏–¥–µ—Ç —á–∏—Å–ª–æ 1-3, –∑–∞—Ç–µ–º —Ç–æ—á–∫–∞ –∏ —á–∏—Å–ª–æ - —ç—Ç–æ –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ (1-3) –∏ —Å—É–º–º–∞
   - –ü—Ä–∏–º–µ—Ä—ã: "Monero 2.300" -> {"currency": "XMR", "xmr_number": 2, "usd_amount": 300}
   - –ü—Ä–∏–º–µ—Ä—ã: "–º–æ–Ω–µ—Ä–æ-2 300" -> {"currency": "XMR", "xmr_number": 2, "usd_amount": 300}
   - –ü—Ä–∏–º–µ—Ä—ã: "–º–∞–Ω–µ—Ä–∞ 1 500" -> {"currency": "XMR", "xmr_number": 1, "usd_amount": 500}
7. –ï—Å–ª–∏ —Å—É–º–º–∞ —É–∫–∞–∑–∞–Ω–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö/–±–∞–∫—Å–∞—Ö –¥–ª—è –∫—Ä–∏–ø—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–±–∏—Ç–∫–∞ 100 –±–∞–∫—Å–æ–≤"), –∏—Å–ø–æ–ª—å–∑—É–π usd_amount –≤–º–µ—Å—Ç–æ amount.
8. –í–ê–ñ–ù–û –æ –∑–Ω–∞–∫–µ —Å—É–º–º—ã:
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —Å–∫–∞–∑–∞–Ω–æ "–º–∏–Ω—É—Å", "–º–∏–Ω—É—Å", "-" –ø–µ—Ä–µ–¥ —á–∏—Å–ª–æ–º - —Å—É–º–º–∞ –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–ê–Ø
   - –ï—Å–ª–∏ –∑–Ω–∞–∫ –Ω–µ —É–∫–∞–∑–∞–Ω (–ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ) - —Å—É–º–º–∞ –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–ê–Ø
   - –ü—Ä–∏–º–µ—Ä—ã: "–º–∏–Ω—É—Å 470 —Ä—É–±–ª–µ–π" -> amount: -470
   - –ü—Ä–∏–º–µ—Ä—ã: "—Ç–µ–∑ —Ç—Ä–∞—Å—Ç –º–∏–Ω—É—Å 160" -> usd_amount: -160
   - –ü—Ä–∏–º–µ—Ä—ã: "–±–∏—Ç–∫–∞ 100" -> usd_amount: 100 (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ)
   - –ü—Ä–∏–º–µ—Ä—ã: "–Ω–∞ –∫–≤–ª–∞ –±–µ–ª–ª–≤–µ–± 230" -> amount: 230 (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ)
9. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è –∫–∞—Ä—Ç: 
   - –í–°–ï–ì–î–ê –∏—â–∏ –∫–∞—Ä—Ç—ã –≤ —Ç–µ–∫—Å—Ç–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ—Ç–æ—á–Ω–æ–µ –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω–æ–µ
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∂–∞–Ω–Ω–∞", "–∂–∞–Ω–Ω—É", "–∫–≤–ª–∞", "–∫–≤–∞–≤–∞–ª") –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã/–±–∞–Ω–∫–∞/—Å—á–µ—Ç–∞ - —ç—Ç–æ –ö–ê–†–¢–ê
   - –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–û —Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø –∏ –∫–∞—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ë–î
   - –ù–ï –∏–∑–º–µ–Ω—è–π —Ä–µ–≥–∏—Å—Ç—Ä, –ù–ï –∑–∞–º–µ–Ω—è–π –±—É–∫–≤—ã, –ù–ï —Å–æ–∫—Ä–∞—â–∞–π –Ω–∞–∑–≤–∞–Ω–∏—è
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —Å–∫–∞–∑–∞–Ω–æ "–ö–í–õ–ê" –∏–ª–∏ "–∫–≤–ª–∞", –Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å "–ö–ê–í–ê–õ" - –∏—Å–ø–æ–ª—å–∑—É–π "–ö–ê–í–ê–õ"
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —Å–∫–∞–∑–∞–Ω–æ "–ë–µ–ª–ª–≤–µ–±", "–ë–µ–ª–í—ç–±", "–±–µ–ª–æ–≤–∞" –∏–ª–∏ "–±–µ–ª–≤–µ–±" –¥–ª—è –≥—Ä—É–ø–ø—ã "–ñ–ê–ù–ù–ê", –Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å "–í–≠–ë –ñ" - –∏—Å–ø–æ–ª—å–∑—É–π "–í–≠–ë –ñ"
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —Å–∫–∞–∑–∞–Ω–æ "–ë–µ–ª–í—ç–±" –¥–ª—è –≥—Ä—É–ø–ø—ã "–ö–ê–í–ê–õ", –Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å "–ë–µ–ª–í—ç–±" - –∏—Å–ø–æ–ª—å–∑—É–π "–ë–µ–ª–í—ç–±"
   - –í–ê–ñ–ù–û: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –¢–û–ß–ù–û —Ç–æ–º—É, —á—Ç–æ —É–∫–∞–∑–∞–Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è –¥–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
   - –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —Å –ø–æ—Ö–æ–∂–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –µ—Å—Ç—å –≤ –¥—Ä—É–≥–æ–π –≥—Ä—É–ø–ø–µ, –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë - –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞—Ä—Ç—É –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≥—Ä—É–ø–ø—ã
   - –ò—â–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è –ü–†–ê–í–ò–õ–¨–ù–û–ô –≥—Ä—É–ø–ø—ã, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –¢–û–ß–ù–û –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ
   - –ü—Ä–∏–º–µ—Ä—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: "–∂–∞–Ω–Ω–∞ –±–µ–ª–æ–≤–∞" -> –≥—Ä—É–ø–ø–∞ "–ñ–ê–ù–ù–ê", –∫–∞—Ä—Ç–∞ "–í–≠–ë –ñ" (–µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ "–±–µ–ª–≤–µ–±")
   - –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ä—Ç—É, –Ω–æ –≤–∏–¥–∏—à—å –≥—Ä—É–ø–ø—É - –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂—É—é –∫–∞—Ä—Ç—É –∏–∑ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
10. –î–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö: 
   - –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–¥ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–±–µ–ª–∫–∏", "—é—Å–¥", "—Ä—É–±")
   - –ï—Å–ª–∏ –Ω–∞–ª–∏—á–Ω—ã–µ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ, –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø–æ–ª–µ "cash" –≤ –±–ª–æ–∫
   - –ü–æ–ª–µ "cash" –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å "name" (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –∏ "amount" (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
   - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π null –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
   - –í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Å—É–º–º—ã —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∏ –∫–∞—Ä—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "230 —Ä—É–±–ª–µ–π –Ω–∞ –∫–≤–ª–∞ –±–µ–ª–ª–≤–µ–±", "–ø–æ–ª–æ–∂–∏–ª–∏ –Ω–∞ –∫–≤–ª–∞ –±–µ–ª–ª–≤–µ–± 230"), —ç—Ç–æ –ö–ê–†–¢–ê, –∞ –Ω–µ –Ω–∞–ª–∏—á–Ω—ã–µ!
11. –î–ª—è –∫–∞—Ä—Ç –≤ –∫–æ–º–∞–Ω–¥–µ "add":
   - –§—Ä–∞–∑—ã, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –∫–∞—Ä—Ç—É: "–Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞]", "–Ω–∞ –∫–∞—Ä—Ç—É [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞]", "–ø–æ–ª–æ–∂–∏–ª–∏ –Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞]", "[—Å—É–º–º–∞] –Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞]", "–Ω–∞ [–∏–º—è] [–∫–∞—Ä—Ç–∞] –ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞]", "–ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞] –Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞]"
   - –ü—Ä–∏–º–µ—Ä—ã: "–Ω–∞ –∫–≤–ª–∞ –±–µ–ª–ª–≤–µ–± –ø–æ–ª–æ–∂–∏–ª–∏ 230", "230 —Ä—É–±–ª–µ–π –Ω–∞ –∫–≤–ª–∞ –±–µ–ª–ª–≤–µ–±", "–ø–æ–ª–æ–∂–∏–ª–∏ –Ω–∞ –∂–∞–Ω–Ω–∞ —Å–±–µ—Ä 500", "–Ω–∞ –∂–∞–Ω–Ω—É –±–µ–ª–æ–≤–∞ –ø–µ—Ä–µ–≤–µ–ª–∏ 200", "–ø–µ—Ä–µ–≤–µ–ª–∏ 200 –Ω–∞ –∂–∞–Ω–Ω–∞ –±–µ–ª–æ–≤–∞"
   - –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Ñ—Ä–∞–∑–∞ "–Ω–∞ [—á—Ç–æ-—Ç–æ] –ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞]" –∏–ª–∏ "–ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞] –Ω–∞ [—á—Ç–æ-—Ç–æ]" - —ç—Ç–æ –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –ö–ê–†–¢–ê, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ—Ç–æ—á–Ω–æ–µ
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∂–∞–Ω–Ω–∞", "–∂–∞–Ω–Ω—É") –∏ –ª—é–±–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã/–±–∞–Ω–∫–∞/—Å—á–µ—Ç–∞ - —ç—Ç–æ –ö–ê–†–¢–ê
   - –ï—Å–ª–∏ —Å—É–º–º–∞ —É–∫–∞–∑–∞–Ω–∞ –≤ —Ä—É–±–ª—è—Ö –∏ –ø–æ—Å–ª–µ –Ω–µ—ë –∏–¥–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã/–∫–∞—Ä—Ç—ã - —ç—Ç–æ –ö–ê–†–¢–ê
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∏ –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ —Å—É–º–º—ã - —ç—Ç–æ –ö–ê–†–¢–ê, –∞ –Ω–µ –Ω–∞–ª–∏—á–Ω—ã–µ
12. –î–ª—è –∫–æ–º–∞–Ω–¥—ã "move":
   - –ù—É–∂–Ω—ã –î–í–ï –∫–∞—Ä—Ç—ã: –æ–¥–Ω–∞ "–æ—Ç–∫—É–¥–∞" (—Å –∫–∞—Ä—Ç—ã), –¥—Ä—É–≥–∞—è "–∫—É–¥–∞" (–Ω–∞ –∫–∞—Ä—Ç—É)
   - –ò—Å–ø–æ–ª—å–∑—É–π "card_from" –¥–ª—è –∫–∞—Ä—Ç—ã-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏ "card_to" –¥–ª—è –∫–∞—Ä—Ç—ã-–ø–æ–ª—É—á–∞—Ç–µ–ª—è
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –¥–≤–∞ –±–ª–æ–∫–∞ —Å "card" - –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ —ç—Ç–æ "–æ—Ç–∫—É–¥–∞", –≤—Ç–æ—Ä–æ–π "–∫—É–¥–∞"
   - –§—Ä–∞–∑—ã: "—Å –∫–∞—Ä—Ç—ã", "—Å–æ –∫–∞—Ä—Ç—ã", "–æ—Ç –∫–∞—Ä—Ç—ã" - —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∫–∞—Ä—Ç—É-–∏—Å—Ç–æ—á–Ω–∏–∫
   - –§—Ä–∞–∑—ã: "–Ω–∞ –∫–∞—Ä—Ç—É", "–≤ –∫–∞—Ä—Ç—É" - —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∫–∞—Ä—Ç—É-–ø–æ–ª—É—á–∞—Ç–µ–ª—å
   - –°—É–º–º–∞ –æ–±—ã—á–Ω–æ –æ–¥–Ω–∞ –¥–ª—è –æ–±–µ–∏—Ö –∫–∞—Ä—Ç (–ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è —Å –æ–¥–Ω–æ–π –Ω–∞ –¥—Ä—É–≥—É—é), –≤ –ø–µ—Ä–≤–æ–π —Å–æ –∑–Ω–∞–∫–æ–º "-", –≤–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
13. –†–∞–∑–ª–∏—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∏ –Ω–∞–ª–∏—á–Ω—ã—Ö:
   - –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Å—É–º–º—ã –∏–¥–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∏ –∫–∞—Ä—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "230 —Ä—É–±–ª–µ–π –Ω–∞ –∫–≤–ª–∞ –±–µ–ª–ª–≤–µ–±") - —ç—Ç–æ –ö–ê–†–¢–ê
   - –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Å—É–º–º—ã –∏–¥–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞–ª—é—Ç–∞ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "230 —Ä—É–±–ª–µ–π", "100 –¥–æ–ª–ª–∞—Ä–æ–≤") - —ç—Ç–æ –Ω–∞–ª–∏—á–Ω—ã–µ
   - –§—Ä–∞–∑—ã "–ø–æ–ª–æ–∂–∏–ª–∏ –Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞]", "–Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞] –ø–æ–ª–æ–∂–∏–ª–∏" - —ç—Ç–æ –ö–ê–†–¢–ê
   - –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –∏ –≥—Ä—É–ø–ø–∞, –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã - —ç—Ç–æ –≤—Å–µ–≥–¥–∞ –ö–ê–†–¢–ê, –¥–∞–∂–µ –µ—Å–ª–∏ —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö

–í–ê–ñ–ù–û: 
- –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π –≤–∞–ª–∏–¥–Ω—ã–π JSON. 
- –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞, –≤–µ—Ä–Ω–∏ {"command": null}.
- –î–ª—è –∫–∞—Ä—Ç: –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–´–ï –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ë–î - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏, –Ω–æ –ª—É—á—à–µ —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è.
- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Ñ—Ä–∞–∑–∞ "–Ω–∞ [–≥—Ä—É–ø–ø–∞] [—á—Ç–æ-—Ç–æ] –ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞]" –∏–ª–∏ "–ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞] –Ω–∞ [–≥—Ä—É–ø–ø–∞] [—á—Ç–æ-—Ç–æ]" - —ç—Ç–æ –í–°–ï–ì–î–ê –∫–∞—Ä—Ç–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–µ—Ç–æ—á–Ω–æ–µ –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω–æ–µ. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂—É—é –∫–∞—Ä—Ç—É –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã.
- –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≥—Ä—É–ø–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∂–∞–Ω–Ω–∞", "–∂–∞–Ω–Ω—É", "–∫–≤–ª–∞") –∏ –µ—Å—Ç—å —Å—É–º–º–∞ —Å –ø—Ä–µ–¥–ª–æ–≥–æ–º "–Ω–∞" –∏–ª–∏ "–ø–µ—Ä–µ–≤–µ–ª–∏" - —ç—Ç–æ –∫–∞—Ä—Ç–∞, –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π –µ—ë!"""

	# –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞: –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ "Monero 2.300" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "Monero 2 300"
	# –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ Whisper —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç "–º–æ–Ω–µ—Ä–æ-2 300" –∫–∞–∫ "Monero 2.300"
	text_processed = text
	# –ü–∞—Ç—Ç–µ—Ä–Ω 1: "Monero"/"–º–æ–Ω–µ—Ä–æ"/"–º–∞–Ω–µ—Ä–∞" + –ø—Ä–æ–±–µ–ª + —á–∏—Å–ª–æ 1-3 + —Ç–æ—á–∫–∞ + —á–∏—Å–ª–æ (2+ —Ü–∏—Ñ—Ä—ã, –Ω–æ –Ω–µ –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ) = –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ –∏ —Å—É–º–º–∞
	# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏ –∏–¥–µ—Ç —á–∏—Å–ª–æ —Å 2+ —Ü–∏—Ñ—Ä–∞–º–∏ (—ç—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Å—É–º–º–∞, –∞ –Ω–µ –¥–µ—Å—è—Ç–∏—á–Ω–∞—è —á–∞—Å—Ç—å)
	xmr_pattern1 = r'(?i)(monero|–º–æ–Ω–µ—Ä–æ|–º–∞–Ω–µ—Ä–∞|xmr)\s+([123])\.(\d{2,})'
	# –ü–∞—Ç—Ç–µ—Ä–Ω 2: "Monero"/"–º–æ–Ω–µ—Ä–æ"/"–º–∞–Ω–µ—Ä–∞" + –¥–µ—Ñ–∏—Å + —á–∏—Å–ª–æ 1-3 + –ø—Ä–æ–±–µ–ª + —á–∏—Å–ª–æ = –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ –∏ —Å—É–º–º–∞
	xmr_pattern2 = r'(?i)(monero|–º–æ–Ω–µ—Ä–æ|–º–∞–Ω–µ—Ä–∞|xmr)-([123])\s+(\d+)'
	
	def fix_xmr_decimal(match):
		crypto_name = match.group(1)
		wallet_num = match.group(2)
		amount = match.group(3)
		# –£–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ –∏–∑ —Å—É–º–º—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
		amount_clean = str(int(amount))
		return f"{crypto_name} {wallet_num} {amount_clean}"
	
	def fix_xmr_hyphen(match):
		crypto_name = match.group(1)
		wallet_num = match.group(2)
		amount = match.group(3)
		return f"{crypto_name} {wallet_num} {amount}"
	
	# –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω —Å –¥–µ—Ñ–∏—Å–æ–º
	text_processed = re.sub(xmr_pattern2, fix_xmr_hyphen, text_processed)
	# –ó–∞—Ç–µ–º –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω —Å —Ç–æ—á–∫–æ–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏ >= 2 —Ü–∏—Ñ—Ä)
	text_processed = re.sub(xmr_pattern1, fix_xmr_decimal, text_processed)
	if text_processed != text:
		logger.debug(f"üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω XMR –ø–∞—Ç—Ç–µ—Ä–Ω: '{text}' -> '{text_processed}'")
	
	# –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∫–∞—Ä—Ç: –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–Ω–∞ –∂–∞–Ω–Ω—É –±–µ–ª–æ–≤–∞ –ø–µ—Ä–µ–≤–µ–ª–∏"
	# –ó–∞–º–µ–Ω—è–µ–º "–Ω–∞ [–∏–º—è] [—Ñ–∞–º–∏–ª–∏—è/–Ω–∞–∑–≤–∞–Ω–∏–µ] –ø–µ—Ä–µ–≤–µ–ª–∏" –Ω–∞ "–Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞] –ø–µ—Ä–µ–≤–µ–ª–∏" –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
	card_phrases_pattern = r'(?i)\b–Ω–∞\s+([–∞-—è—ë]+)\s+([–∞-—è—ë]+)\s+–ø–µ—Ä–µ–≤–µ–ª–∏\b'
	def normalize_card_phrase(match):
		group_name = match.group(1)
		card_name = match.group(2)
		# –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —á—Ç–æ —ç—Ç–æ –∫–∞—Ä—Ç–∞
		return f"–Ω–∞ {group_name} {card_name} –∫–∞—Ä—Ç—É –ø–µ—Ä–µ–≤–µ–ª–∏"
	
	text_processed = re.sub(card_phrases_pattern, normalize_card_phrase, text_processed)
	if text_processed != text:
		logger.debug(f"üîß –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –∫–∞—Ä—Ç—ã: '{text}' -> '{text_processed}'")
	
	user_prompt = f"""–†–∞—Å–ø–æ–∑–Ω–∞–π –∫–æ–º–∞–Ω–¥—É –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:

{text_processed}

{f'–ö–æ–Ω—Ç–µ–∫—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:\n{db_context}' if db_context else ''}

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤."""

	try:
		response = openai_client.chat.completions.create(
			model="gpt-3.5-turbo",
			messages=[
				{"role": "system", "content": system_prompt},
				{"role": "user", "content": user_prompt}
			],
			max_tokens=1000,
			temperature=0.3  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
		)
		
		gpt_response = response.choices[0].message.content
		logger.info(f"üìù GPT –æ—Ç–≤–µ—Ç: {gpt_response}")
		
		# –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
		import json
		# –£–±–∏—Ä–∞–µ–º markdown –∫–æ–¥ –±–ª–æ–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
		gpt_response = gpt_response.strip()
		if gpt_response.startswith("```json"):
			gpt_response = gpt_response[7:]
		if gpt_response.startswith("```"):
			gpt_response = gpt_response[3:]
		if gpt_response.endswith("```"):
			gpt_response = gpt_response[:-3]
		gpt_response = gpt_response.strip()
		
		parsed = json.loads(gpt_response)
		logger.info(f"‚úÖ GPT —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª –∫–æ–º–∞–Ω–¥—É: {parsed.get('command')}")
		
		# –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç GPT, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ –ë–î
		if db and parsed.get("command") in ["add", "move"]:
			logger.debug(f"üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ GPT: –¥–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ {parsed}")
			
			# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏–ª –ª–∏ GPT –∫–∞—Ä—Ç—É –≤ —Ç–µ–∫—Å—Ç–µ
			# –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞ "–Ω–∞ [–≥—Ä—É–ø–ø–∞] [—á—Ç–æ-—Ç–æ] –ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞]" –∏–ª–∏ "–ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞] –Ω–∞ [–≥—Ä—É–ø–ø–∞] [—á—Ç–æ-—Ç–æ]"
			if parsed.get("command") == "add" and parsed.get("blocks"):
				# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∏ —Å—É–º–º—ã, –Ω–æ –Ω–µ—Ç –∫–∞—Ä—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ
				has_card_in_blocks = any("card" in block for block in parsed.get("blocks", []))
				
				if not has_card_in_blocks:
					# –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–∞—Ä—Ç –≤ —Ç–µ–∫—Å—Ç–µ
					# –ü–∞—Ç—Ç–µ—Ä–Ω 1: "–Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞] –ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞]"
					pattern1 = r'(?i)\b–Ω–∞\s+([–∞-—è—ë]+)\s+([–∞-—è—ë]+)\s+–ø–µ—Ä–µ–≤–µ–ª–∏\s+(\d+)'
					match1 = re.search(pattern1, text_processed)
					if match1:
						group_name = match1.group(1)
						card_name = match1.group(2)
						amount_str = match1.group(3)
						
						# –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç—É –ø–æ –≥—Ä—É–ø–ø–µ –∏ –Ω–∞–∑–≤–∞–Ω–∏—é
						card_result = await find_card_by_group_and_name(group_name, card_name, db, original_text=match1.group(0))
						if card_result:
							# –ù–∞—à–ª–∏ –∫–∞—Ä—Ç—É - –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë –≤ –ø–µ—Ä–≤—ã–π –±–ª–æ–∫
							if parsed.get("blocks") and len(parsed["blocks"]) > 0:
								first_block = parsed["blocks"][0]
								# –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É –∫–∞—Ä—Ç—ã
								group_obj = None
								if card_result.get("group_id"):
									group_obj = await db.get_card_group_by_id(card_result["group_id"])
								
								first_block["card"] = {
									"group": group_obj["name"] if group_obj else "",
									"name": card_result["card_name"],
									"amount": int(amount_str)
								}
								logger.info(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–∞—è GPT –∫–∞—Ä—Ç–∞: –≥—Ä—É–ø–ø–∞='{group_obj['name'] if group_obj else ''}', –∫–∞—Ä—Ç–∞='{card_result['card_name']}', —Å—É–º–º–∞={amount_str}")
					else:
						# –ü–∞—Ç—Ç–µ—Ä–Ω 2: "–ø–µ—Ä–µ–≤–µ–ª–∏ [—Å—É–º–º–∞] –Ω–∞ [–≥—Ä—É–ø–ø–∞] [–∫–∞—Ä—Ç–∞]"
						pattern2 = r'(?i)\b–ø–µ—Ä–µ–≤–µ–ª–∏\s+(\d+)\s+–Ω–∞\s+([–∞-—è—ë]+)\s+([–∞-—è—ë]+)'
						match2 = re.search(pattern2, text_processed)
						if match2:
							amount_str = match2.group(1)
							group_name = match2.group(2)
							card_name = match2.group(3)
							
							# –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç—É –ø–æ –≥—Ä—É–ø–ø–µ –∏ –Ω–∞–∑–≤–∞–Ω–∏—é
							card_result = await find_card_by_group_and_name(group_name, card_name, db, original_text=match2.group(0))
							if card_result:
								# –ù–∞—à–ª–∏ –∫–∞—Ä—Ç—É - –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë –≤ –ø–µ—Ä–≤—ã–π –±–ª–æ–∫
								if parsed.get("blocks") and len(parsed["blocks"]) > 0:
									first_block = parsed["blocks"][0]
									# –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É –∫–∞—Ä—Ç—ã
									group_obj = None
									if card_result.get("group_id"):
										group_obj = await db.get_card_group_by_id(card_result["group_id"])
									
									first_block["card"] = {
										"group": group_obj["name"] if group_obj else "",
										"name": card_result["card_name"],
										"amount": int(amount_str)
									}
									logger.info(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–∞—è GPT –∫–∞—Ä—Ç–∞: –≥—Ä—É–ø–ø–∞='{group_obj['name'] if group_obj else ''}', –∫–∞—Ä—Ç–∞='{card_result['card_name']}', —Å—É–º–º–∞={amount_str}")
			
			parsed = await validate_and_fix_gpt_response(parsed, db)
			logger.debug(f"üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ GPT: –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ {parsed}")
		
		return parsed
		
	except json.JSONDecodeError as e:
		logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç GPT: {e}, –æ—Ç–≤–µ—Ç: {gpt_response}")
		return None
	except Exception as e:
		logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ GPT: {e}")
		return None


async def handle_voice_command(message: Message, bot: Bot, db=None) -> Optional[str]:
	"""
	–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
	
	Args:
		message: –°–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
		bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
		
	Returns:
		–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–ª–∏ None
	"""
	if not message.voice:
		return None
	
	logger.info(f"üé§ –ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id if message.from_user else None}")
	
	# –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ä–µ—á—å
	text = await transcribe_voice(bot, message.voice, db)
	if not text:
		return None
	
	# –ü–∞—Ä—Å–∏–º –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ GPT
	parsed = await parse_voice_with_gpt(text, db)
	if parsed and parsed.get("command"):
		command = parsed["command"]
		logger.info(f"‚úÖ GPT –æ–ø—Ä–µ–¥–µ–ª–∏–ª –∫–æ–º–∞–Ω–¥—É: {command}")
		return command
	else:
		# Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞
		logger.warning("‚ö†Ô∏è GPT –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª –∫–æ–º–∞–Ω–¥—É, –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥")
		command = parse_voice_command(text)
		if command:
			logger.info(f"‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥): {command}")
		else:
			logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –∏–∑ —Ç–µ–∫—Å—Ç–∞: {text}")
		return command


def parse_add_operation_data(text: str, crypto_keywords: Optional[Dict[str, List[str]]] = None) -> Dict[str, Any]:
	"""
	–ü–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞.
	
	–ü—Ä–∏–º–µ—Ä: "–û–ø–µ—Ä–∞—Ü–∏—è, –±–∏—Ç–æ–∫ 100, –∂–∞–Ω–Ω–∞ –±–µ–ª–≤–µ–± 300, –Ω–∞–ª–∏—á–Ω—ã–µ –±–µ–ª–∫–∏ 300, –Ω–∞–ª–∏—á–Ω—ã–µ —é—Å–¥ 200"
	
	Args:
		text: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
		
	Returns:
		–°–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
		{
			"blocks": [
				{
					"crypto": {"currency": "BTC", "amount": 100},
					"card": {"group": "–ñ–ê–ù–ù–ê", "name": "–ë–ï–õ–í–ï–ë", "amount": 300},
					"cash": {"name": "–±–µ–ª–∫–∏", "amount": 300}
				},
				{
					"cash": {"name": "—é—Å–¥", "amount": 200}
				}
			]
		}
	"""
	result = {
		"blocks": []
	}
	
	if not text:
		return result
	
	# –£–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É "–æ–ø–µ—Ä–∞—Ü–∏—è" –∏ –≤–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã
	text = text.lower().strip()
	
	# –£–±–∏—Ä–∞–µ–º –≤–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã
	intro_phrases = [
		"–Ω—É–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é",
		"–∑–∞–ø–∏—Å–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é",
		"–¥–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é",
		"–Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è",
		"–æ–ø–µ—Ä–∞—Ü–∏—è",
		"add operation"
	]
	
	for phrase in intro_phrases:
		if phrase in text:
			# –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é —Ñ—Ä–∞–∑—ã –∏ –±–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –Ω–µ—ë
			phrase_pos = text.find(phrase)
			if phrase_pos != -1:
				text_after = text[phrase_pos + len(phrase):].strip()
				# –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –∏ –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞
				text_after = text_after.lstrip(".,:;!?")
				# –£–±–∏—Ä–∞–µ–º –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ "–º–Ω–µ", "–¥–∞–ª", "–¥–∞–ª–∏" –∏ —Ç.–¥.
				intro_words = ["–º–Ω–µ", "–¥–∞–ª", "–¥–∞–ª–∏", "–ø–µ—Ä–µ–≤–µ–ª–∏", "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏", "–Ω–∞", "–∏"]
				words = text_after.split()
				# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–≤–æ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ –≤ –Ω–∞—á–∞–ª–µ
				while words and words[0] in intro_words:
					words.pop(0)
				text = " ".join(words).strip()
				break
	
	# –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ –∑–∞–ø—è—Ç—ã–º –∏–ª–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–µ—Å–ª–∏ –∑–∞–ø—è—Ç—ã—Ö –Ω–µ—Ç)
	parts = [p.strip() for p in text.split(",") if p.strip()]
	
	# –ï—Å–ª–∏ –∑–∞–ø—è—Ç—ã—Ö –Ω–µ—Ç, —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º "–Ω–∞–ª–∏—á–Ω—ã–µ" –∏ "–∫–∞—Ä—Ç–∞"
	if len(parts) == 1 and "," not in text:
		# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
		separator_keywords = ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash", "–∫–∞—Ä—Ç–∞", "–∫–∞—Ä—Ç—ã", "card", "cards", "–ø–µ—Ä–µ–≤–µ–ª–∏ –Ω–∞ –∫–∞—Ä—Ç—É", "–ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—É"]
		
		# –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
		keyword_positions = []
		for keyword in separator_keywords:
			# –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
			pattern = r'\b' + re.escape(keyword) + r'\b'
			for match in re.finditer(pattern, text, re.IGNORECASE):
				keyword_positions.append((match.start(), match.end(), keyword))
		
		# –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–∑–∏—Ü–∏–∏
		keyword_positions.sort(key=lambda x: x[0])
		
		if len(keyword_positions) > 0:
			parts = []
			start_idx = 0
			
			for i, (kw_start, kw_end, keyword) in enumerate(keyword_positions):
				# –ß–∞—Å—Ç—å –¥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
				if start_idx < kw_start:
					part = text[start_idx:kw_start].strip()
					if part:
						parts.append(part)
				
				# –ß–∞—Å—Ç—å —Å –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ –∏–ª–∏ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—Å—Ç–∞
				next_start = keyword_positions[i+1][0] if i+1 < len(keyword_positions) else len(text)
				part = text[kw_start:next_start].strip()
				if part:
					parts.append(part)
				
				start_idx = next_start
			
			# –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞
			if start_idx < len(text):
				remaining = text[start_idx:].strip()
				if remaining:
					parts.append(remaining)
		else:
			# –ï—Å–ª–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –Ω–µ—Ç, —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ —á–∏—Å–ª–∞–º (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
			numbers = list(re.finditer(r'\d+(?:\.\d+)?', text))
			if len(numbers) > 1:
				parts = []
				# –ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å - –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –ø–µ—Ä–≤–æ–≥–æ —á–∏—Å–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
				first_match = numbers[0]
				parts.append(text[:first_match.end()].strip())
				
				# –û—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ - –æ—Ç –∫–æ–Ω—Ü–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∏—Å–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–≥–æ —á–∏—Å–ª–∞
				for i in range(1, len(numbers)):
					prev_match = numbers[i-1]
					curr_match = numbers[i]
					parts.append(text[prev_match.end():curr_match.end()].strip())
				
				# –ü–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å - –æ—Ç –∫–æ–Ω—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∏—Å–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ —á–∏—Å–ª–∞)
				last_match = numbers[-1]
				if last_match.end() < len(text):
					parts.append(text[last_match.end():].strip())
			elif len(numbers) == 1:
				# –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —á–∏—Å–ª–æ, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
				parts = [text]
	
	logger.debug(f"üîç –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏: {parts}")
	
	# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞–ª–∏—á–Ω—ã—Ö –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
	cash_names = {
		"–±–µ–ª–∫–∏": ["–±–µ–ª–∫–∏", "–±–µ–ª–∫–∞", "squirrel"],
		"—é—Å–¥": ["—é—Å–¥", "usd", "–±–∞–∫—Å—ã", "–±–∞–∫—Å", "–¥–æ–ª–ª–∞—Ä", "–¥–æ–ª–ª–∞—Ä—ã", "dollar", "dollars"],
		"—Ä—É–±": ["—Ä—É–±", "—Ä—É–±–ª—å", "—Ä—É–±–ª–∏", "rub", "ruble"]
	}
	
	current_block = {}
	previous_part = None  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —á–∞—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–Ω—ã—Ö
	
	for part_idx, part in enumerate(parts):
		part = part.strip()
		if not part:
			continue
		
		logger.debug(f"üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏ {part_idx + 1}/{len(parts)}: '{part}'")
		
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —á–∞—Å—Ç–∏ –∏ –Ω–∞–ª–∏—á–Ω—ã–µ, –∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
		# –ï—Å–ª–∏ –¥–∞, —Ä–∞–∑–¥–µ–ª—è–µ–º —á–∞—Å—Ç—å –Ω–∞ –¥–≤–µ: –æ–¥–Ω—É –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö, –¥—Ä—É–≥—É—é –¥–ª—è –∫—Ä–∏–ø—Ç—ã
		cash_keywords = ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash"]
		has_cash_keyword = any(kw in part.lower() for kw in cash_keywords)
		cash_found_in_part = None
		for cash_name, keywords in cash_names.items():
			if any(kw in part.lower() for kw in keywords):
				cash_found_in_part = cash_name
				break
		
		# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ crypto_keywords –∏–ª–∏ fallback –Ω–∞ —Ö–∞—Ä–¥–∫–æ–¥
		if crypto_keywords is None:
			crypto_keywords = {
				"tez_trust": ["—Ç–µ–∑–µ—Ä —Ç—Ä–∞—Å—Ç", "—Ç–µ–∑–µ—Ä—Ç—Ä–∞—Å—Ç", "tez trust", "teztrust"],
				"btc": ["–±–∏—Ç–æ–∫", "–±—Ç—Ü", "–±–∏—Ç–∫–æ–∏–Ω", "bitcoin", "btc"],
				"ltc": ["–ª–∞–π—Ç–∫–æ–∏–Ω", "litecoin", "ltc", "–ª—Ç–∫", "ltk"],
				"xmr": ["–º–æ–Ω–µ—Ä–æ", "monero", "xmr", "–º–∞–Ω–µ—Ä–∞"],
				"usdt": ["—é—Å–¥—Ç", "usdt", "tether"],
				"tez": ["—Ç–µ–∑–µ—Ä"]
			}
		crypto_found_in_part = None
		for crypto_code, keywords in crypto_keywords.items():
			for kw in keywords:
				if kw in part.lower():
					crypto_found_in_part = crypto_code.upper()
					break
			if crypto_found_in_part:
				break
		
		# –ï—Å–ª–∏ –≤ —á–∞—Å—Ç–∏ –µ—Å—Ç—å –∏ –Ω–∞–ª–∏—á–Ω—ã–µ, –∏ –∫—Ä–∏–ø—Ç–∞, —Ä–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏
		if (has_cash_keyword or cash_found_in_part) and crypto_found_in_part:
			# –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏–∏ –∫—Ä–∏–ø—Ç—ã –∏ –Ω–∞–ª–∏—á–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ
			crypto_pos = -1
			cash_pos = -1
			
			# –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –∫—Ä–∏–ø—Ç—ã
			for crypto_code, keywords in crypto_keywords.items():
				for kw in keywords:
					pos = part.lower().find(kw)
					if pos != -1 and (crypto_pos == -1 or pos < crypto_pos):
						crypto_pos = pos
						crypto_found_in_part = crypto_code.upper()
				if crypto_pos != -1:
					break
			
			# –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞–ª–∏—á–Ω—ã—Ö
			if has_cash_keyword:
				for kw in cash_keywords:
					pos = part.lower().find(kw)
					if pos != -1 and (cash_pos == -1 or pos < cash_pos):
						cash_pos = pos
			if cash_found_in_part:
				for cash_name, keywords in cash_names.items():
					if cash_name == cash_found_in_part:
						for kw in keywords:
							pos = part.lower().find(kw)
							if pos != -1 and (cash_pos == -1 or pos < cash_pos):
								cash_pos = pos
						break
			
			if crypto_pos != -1 and cash_pos != -1:
				# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –∏–¥–µ—Ç –ø–µ—Ä–≤—ã–º: –Ω–∞–ª–∏—á–Ω—ã–µ –∏–ª–∏ –∫—Ä–∏–ø—Ç–∞
				if cash_pos < crypto_pos:
					# –ù–∞–ª–∏—á–Ω—ã–µ –∏–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏: "–Ω–∞–ª–∏—á–Ω—ã–µ –±–µ–ª–∫–∏ 316 –ª—Ç–∫ 250"
					cash_part = part[:crypto_pos].strip()
					crypto_part = part[crypto_pos:].strip()
				else:
					# –ö—Ä–∏–ø—Ç–∞ –∏–¥–µ—Ç –ø–µ—Ä–≤–æ–π: "–ª—Ç–∫ 250 –Ω–∞–ª–∏—á–Ω—ã–µ –±–µ–ª–∫–∏ 316"
					crypto_part = part[:cash_pos].strip()
					cash_part = part[cash_pos:].strip()
				
				logger.debug(f"üîç –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å—Ç–∏ '{part}' –Ω–∞ –¥–≤–µ: –Ω–∞–ª–∏—á–Ω—ã–µ='{cash_part}', –∫—Ä–∏–ø—Ç–∞='{crypto_part}'")
				
				# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–∞—Å—Ç—å —Å –Ω–∞–ª–∏—á–Ω—ã–º–∏
				if cash_part:
					# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–∞ –≤ cash_part (–¥–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –Ω–∞–ª–∏—á–Ω—ã—Ö)
					card_found_in_cash_part = False
					cash_keywords_in_part = ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash"]
					cash_pos_in_cash_part = -1
					for kw in cash_keywords_in_part:
						pos = cash_part.lower().find(kw)
						if pos != -1:
							cash_pos_in_cash_part = pos
							break
					
					# –ï—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –Ω–∞–ª–∏—á–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç—å –¥–æ –Ω–µ–≥–æ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–∞—Ä—Ç—ã
					if cash_pos_in_cash_part != -1:
						card_part = cash_part[:cash_pos_in_cash_part].strip()
						if card_part:
							# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ª–æ–≤–æ "–∫–∞—Ä—Ç–∞" –∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª–æ–≤ –¥–ª—è –∫–∞—Ä—Ç—ã
							card_words = card_part.split()
							if "–∫–∞—Ä—Ç–∞" in card_part.lower() or len(card_words) >= 2:
								# –£–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ "–∫–∞—Ä—Ç–∞" –∏–∑ –Ω–∞—á–∞–ª–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
								if card_words and card_words[0].lower() in ["–∫–∞—Ä—Ç–∞", "–∫–∞—Ä—Ç—ã", "card", "cards"]:
									card_words = card_words[1:]
								
								if len(card_words) >= 2:
									# –ò–∑–≤–ª–µ–∫–∞–µ–º –≥—Ä—É–ø–ø—É –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
									group_name = card_words[0].upper()
									card_name = " ".join(card_words[1:]).upper()
									
									# –ò—â–µ–º —Å—É–º–º—É –¥–ª—è –∫–∞—Ä—Ç—ã (—á–∏—Å–ª–æ –≤ card_part)
									card_numbers = re.findall(r'\d+(?:\.\d+)?', card_part)
									card_amount = int(float(card_numbers[-1])) if card_numbers else None
									
									if card_amount:
										# –ï—Å–ª–∏ –≤ —Ç–µ–∫—É—â–µ–º –±–ª–æ–∫–µ —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫ –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
										if "card" in current_block and current_block["card"]:
											if current_block:
												if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) > 1:
													first_cash = current_block["cash"][0]
													first_block = {k: v for k, v in current_block.items() if k != "cash"}
													first_block["cash"] = first_cash
													result["blocks"].append(first_block)
													for cash_item in current_block["cash"][1:]:
														result["blocks"].append({"cash": cash_item})
												else:
													if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) == 1:
														current_block["cash"] = current_block["cash"][0]
													result["blocks"].append(current_block)
											current_block = {}
										
										current_block["card"] = {
											"group": group_name,
											"name": card_name,
											"amount": card_amount,
											"original_text": card_part
										}
										logger.debug(f"üîç –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Ä—Ç–∞ –∏–∑ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏: {group_name} {card_name} {card_amount}")
										card_found_in_cash_part = True
					
					# –¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–ª–∏—á–Ω—ã–µ –∏–∑ cash_part
					# –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞, –±–µ—Ä–µ–º —á–∞—Å—Ç—å –ø–æ—Å–ª–µ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ –Ω–∞–ª–∏—á–Ω—ã—Ö
					if card_found_in_cash_part and cash_pos_in_cash_part != -1:
						cash_part_for_processing = cash_part[cash_pos_in_cash_part:].strip()
					else:
						cash_part_for_processing = cash_part
					
					# –ò—â–µ–º —á–∏—Å–ª–æ –≤ —á–∞—Å—Ç–∏ —Å –Ω–∞–ª–∏—á–Ω—ã–º–∏
					cash_numbers = re.findall(r'\d+(?:\.\d+)?', cash_part_for_processing)
					cash_amount = int(float(cash_numbers[-1])) if cash_numbers else None
					
					# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö –∏–∑ —á–∞—Å—Ç–∏
					cash_name_found = None
					for cash_name, keywords in cash_names.items():
						if any(kw in cash_part_for_processing.lower() for kw in keywords):
							cash_name_found = cash_name
							break
					
					if cash_amount and cash_name_found:
						# –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–ª–∏—á–Ω—ã–µ –≤ —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫
						if "cash" not in current_block:
							current_block["cash"] = []
						current_block["cash"].append({
							"name": cash_name_found,
							"amount": cash_amount,
							"original_text": cash_part_for_processing
						})
						logger.debug(f"üîç –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞–ª–∏—á–Ω—ã–µ –∏–∑ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏: {cash_name_found} {cash_amount}")
				
				# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–∞—Å—Ç—å —Å –∫—Ä–∏–ø—Ç–æ–π
				if crypto_part:
					# –ò—â–µ–º —á–∏—Å–ª–æ –≤ —á–∞—Å—Ç–∏ —Å –∫—Ä–∏–ø—Ç–æ–π
					crypto_numbers = re.findall(r'\d+(?:\.\d+)?', crypto_part)
					crypto_amount = int(float(crypto_numbers[-1])) if crypto_numbers else None
					
					if crypto_amount:
						# –ï—Å–ª–∏ –≤ —Ç–µ–∫—É—â–µ–º –±–ª–æ–∫–µ —É–∂–µ –µ—Å—Ç—å –∫—Ä–∏–ø—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫ –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
						if "crypto" in current_block and current_block["crypto"]:
							if current_block:
								if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) > 1:
									first_cash = current_block["cash"][0]
									first_block = {k: v for k, v in current_block.items() if k != "cash"}
									first_block["cash"] = first_cash
									result["blocks"].append(first_block)
									for cash_item in current_block["cash"][1:]:
										result["blocks"].append({"cash": cash_item})
								else:
									if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) == 1:
										current_block["cash"] = current_block["cash"][0]
									result["blocks"].append(current_block)
							current_block = {}
						
						current_block["crypto"] = {
							"currency": crypto_found_in_part,
							"amount": crypto_amount,
							"original_text": crypto_part
						}
						logger.debug(f"üîç –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏–ø—Ç–∞ –∏–∑ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏: {crypto_found_in_part} {crypto_amount}")
				
				# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–æ–π —á–∞—Å—Ç–∏, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –µ—ë —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–π
				previous_part = part
				continue
		
		# –ò—â–µ–º —á–∏—Å–ª–∞ –≤ –∫–æ–Ω—Ü–µ
		numbers = re.findall(r'\d+(?:\.\d+)?', part)
		# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Å—è—Ç–∏—á–Ω–∞—è —á–∞—Å—Ç—å)
		amount = int(float(numbers[-1])) if numbers else None
		
		# –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è XMR: –µ—Å–ª–∏ –ø–æ—Å–ª–µ "–º–∞–Ω–µ—Ä–∞" –∏–ª–∏ "–º–æ–Ω–µ—Ä–æ" –∏–¥–µ—Ç —á–∏—Å–ª–æ 1-3, —ç—Ç–æ –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞, –∞ –Ω–µ —Å—É–º–º–∞
		# –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Å—É–º–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏ –∏–ª–∏ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–º–∞–Ω–µ—Ä–∞ 1.100")
		part_lower = part.lower()
		xmr_number_from_part = None
		if any(kw in part_lower for kw in ["–º–∞–Ω–µ—Ä–∞", "–º–æ–Ω–µ—Ä–æ", "monero", "xmr"]):
			# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω "–º–∞–Ω–µ—Ä–∞/–º–æ–Ω–µ—Ä–æ [1-3].[—á–∏—Å–ª–æ]" - —ç—Ç–æ –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ –∏ —Å—É–º–º–∞ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É
			xmr_with_amount_match = re.search(r'(?:–º–∞–Ω–µ—Ä–∞|–º–æ–Ω–µ—Ä–æ|monero|xmr)\s*([123])\.(\d+)', part_lower)
			if xmr_with_amount_match:
				xmr_number_from_part = int(xmr_with_amount_match.group(1))
				amount = int(float(xmr_with_amount_match.group(2)))
				logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞ {xmr_number_from_part} –∏ —Å—É–º–º–æ–π {amount} —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É: '{part}'")
			else:
				# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á–∏—Å–ª–æ 1, 2 –∏–ª–∏ 3 –ø–æ—Å–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫—Ä–∏–ø—Ç—ã (–±–µ–∑ —Ç–æ—á–∫–∏)
				xmr_number_match = re.search(r'(?:–º–∞–Ω–µ—Ä–∞|–º–æ–Ω–µ—Ä–æ|monero|xmr)\s*([123])(?:\s|$)', part_lower)
				if xmr_number_match:
					xmr_number_from_part = int(xmr_number_match.group(1))
					# –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å amount –∏ —ç—Ç–æ 1, 2 –∏–ª–∏ 3, —Ç–æ —ç—Ç–æ –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞, –∞ –Ω–µ —Å—É–º–º–∞
					if amount == xmr_number_from_part:
						# –≠—Ç–æ –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞, –∞ –Ω–µ —Å—É–º–º–∞
						# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—É–º–º–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏
						if part_idx + 1 < len(parts):
							next_part = parts[part_idx + 1].strip()
							# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ (—ç—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—É–º–º–∞)
							next_part_clean = re.sub(r'\d+(?:\.\d+)?', '', next_part).strip()
							if not next_part_clean or next_part_clean == "":
								# –°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ - —ç—Ç–æ —Å—É–º–º–∞
								next_numbers = re.findall(r'\d+(?:\.\d+)?', next_part)
								if next_numbers:
									amount = int(float(next_numbers[-1]))
									logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞ {xmr_number_from_part}, —Å—É–º–º–∞ –∏–∑ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏: {amount}")
								else:
									logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞ {xmr_number_from_part}, –Ω–æ –Ω–µ—Ç —Å—É–º–º—ã –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏")
							else:
								logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞ {xmr_number_from_part}, –Ω–æ —Å–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ")
						else:
							# –ù–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏, amount –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ (—ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –ª—É—á—à–µ —á–µ–º –Ω–∏—á–µ–≥–æ)
							logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞ {xmr_number_from_part}, –Ω–æ –Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏")
		
		logger.debug(f"üîç –ß–∞—Å—Ç—å '{part}': –Ω–∞–π–¥–µ–Ω–æ —á–∏—Å–µ–ª={len(numbers)}, amount={amount}")
		
		# –ï—Å–ª–∏ –≤ —á–∞—Å—Ç–∏ –Ω–µ—Ç —á–∏—Å–ª–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏
		if amount is None:
			# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —á–∞—Å—Ç—å —Å–ª–æ–≤–æ "–∫–∞—Ä—Ç–∞" - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞—Ä—Ç–∞ –±–µ–∑ —Å—É–º–º—ã
			# (—Å—É–º–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
			has_card_keyword = any(kw in part.lower() for kw in ["–∫–∞—Ä—Ç–∞", "–∫–∞—Ä—Ç—ã", "card", "cards"])
			
			if has_card_keyword:
				# –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª–æ–≤–æ "–∫–∞—Ä—Ç–∞", –∏—â–µ–º —á–∏—Å–ª–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏
				# –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–Ω–∞–ª–∏—á–Ω—ã–µ", —á–∏—Å–ª–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –Ω–∞–ª–∏—á–Ω—ã–º, –Ω–µ –∫ –∫–∞—Ä—Ç–µ
				if part_idx + 1 < len(parts):
					next_part = parts[part_idx + 1].strip()
					next_has_cash = any(kw in next_part.lower() for kw in ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash"])
					if not next_has_cash:
						# –ò—â–µ–º —á–∏—Å–ª–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏
						next_numbers = re.findall(r'\d+(?:\.\d+)?', next_part)
						if next_numbers:
							amount = int(float(next_numbers[0]))
							logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ —Å–ª–æ–≤–æ '–∫–∞—Ä—Ç–∞' –±–µ–∑ —á–∏—Å–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ –∏–∑ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏: {amount}")
						else:
							amount = 0
							logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ —Å–ª–æ–≤–æ '–∫–∞—Ä—Ç–∞' –±–µ–∑ —á–∏—Å–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º amount=0")
					else:
						# –°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å - –Ω–∞–ª–∏—á–Ω—ã–µ, —á–∏—Å–ª–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –Ω–∏–º, –Ω–µ –∫ –∫–∞—Ä—Ç–µ
						amount = 0
						logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ —Å–ª–æ–≤–æ '–∫–∞—Ä—Ç–∞' –±–µ–∑ —á–∏—Å–ª–∞, —Å–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å - –Ω–∞–ª–∏—á–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º amount=0")
				else:
					# –ù–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏
					amount = 0
					logger.debug(f"üîç –ù–∞–π–¥–µ–Ω–æ —Å–ª–æ–≤–æ '–∫–∞—Ä—Ç–∞' –±–µ–∑ —á–∏—Å–ª–∞, –Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º amount=0")
			else:
				# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —á–∞—Å—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö
				cash_found_in_part = None
				for cash_name, keywords in cash_names.items():
					if any(kw in part.lower() for kw in keywords):
						cash_found_in_part = cash_name
						break
				
				# –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —á–∞—Å—Ç—å
				if cash_found_in_part and previous_part:
					prev_numbers = re.findall(r'\d+(?:\.\d+)?', previous_part)
					prev_amount = int(float(prev_numbers[-1])) if prev_numbers else None
					prev_text = re.sub(r'\d+(?:\.\d+)?', '', previous_part).strip().lower()
					
					# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —á–∞—Å—Ç–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ "–Ω–∞–ª–∏—á–Ω—ã–µ" –∏ —á–∏—Å–ª–æ
					cash_keywords = ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash"]
					if prev_amount and any(kw in prev_text for kw in cash_keywords):
						# –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —á–∞—Å—Ç–∏
						amount = prev_amount
						# –û–±—ä–µ–¥–∏–Ω—è–µ–º —á–∞—Å—Ç–∏ –¥–ª—è original_text
						original_part_name = part
						part = f"{previous_part} {part}".strip()
						logger.debug(f"üîç –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã —á–∞—Å—Ç–∏ –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö: '{previous_part}' + '{original_part_name}' = '{part}', —Å—É–º–º–∞ {amount}")
						# –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º previous_part –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–∞–ª—å—à–µ
					else:
						# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É —á–∞—Å—Ç—å
						previous_part = part
						continue
				else:
					# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É —á–∞—Å—Ç—å (–Ω–µ—Ç –Ω–∏ –∫–∞—Ä—Ç—ã, –Ω–∏ –Ω–∞–ª–∏—á–Ω—ã—Ö)
					previous_part = part
					continue
		
		# –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: –µ—Å–ª–∏ —ç—Ç–æ XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞ –∏ —Å–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ,
		# –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ —á–∏—Å–ª–æ –∫–∞–∫ —Å—É–º–º—É –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é —á–∞—Å—Ç—å
		if xmr_number_from_part and part_idx + 1 < len(parts):
			next_part = parts[part_idx + 1].strip()
			# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ
			next_part_clean = re.sub(r'\d+(?:\.\d+)?', '', next_part).strip()
			if not next_part_clean or next_part_clean == "":
				# –°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ - —ç—Ç–æ —Å—É–º–º–∞ –¥–ª—è XMR
				next_numbers = re.findall(r'\d+(?:\.\d+)?', next_part)
				if next_numbers:
					amount = int(float(next_numbers[-1]))
					skip_next_index = part_idx + 1  # –ü–æ–º–µ—á–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é —á–∞—Å—Ç—å –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞
					logger.debug(f"üîç XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞ {xmr_number_from_part}, —Å—É–º–º–∞ –∏–∑ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏: {amount}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é —á–∞—Å—Ç—å")
		
		# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —á–∞—Å—Ç—å –∫–∞–∫ –ø—Ä–µ–¥—ã–¥—É—â—É—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
		# (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á–∞—Å—Ç—å –±—ã–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞, –Ω–µ –ø—Ä–æ–ø—É—â–µ–Ω–∞)
		previous_part = part
		
		# –£–±–∏—Ä–∞–µ–º —á–∏—Å–ª–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
		text_part = re.sub(r'\d+(?:\.\d+)?', '', part).strip()
		logger.debug(f"üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏ '{part}', amount={amount}, text_part='{text_part}'")
		
		# –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É, —á—Ç–æ–±—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –µ—ë –∫–∞–∫ –∫–∞—Ä—Ç—É
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –ø–µ—Ä–≤—ã–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Ç–µ–∑–µ—Ä —Ç—Ä–∞—Å—Ç" –ø–µ—Ä–µ–¥ "—Ç–µ–∑–µ—Ä")
		# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ crypto_keywords –∏–ª–∏ fallback –Ω–∞ —Ö–∞—Ä–¥–∫–æ–¥
		if crypto_keywords is None:
			crypto_keywords = {
				"tez_trust": ["—Ç–µ–∑–µ—Ä —Ç—Ä–∞—Å—Ç", "—Ç–µ–∑–µ—Ä—Ç—Ä–∞—Å—Ç", "tez trust", "teztrust", "tezer trust", "tezer trust"],
				"btc": ["–±–∏—Ç–æ–∫", "–±–∏—Ç–∫–∞", "–±–∏—Ç–∫–æ–∏–Ω", "–±–∏—Ç–∫–æ–∏–Ω–∞", "–±—Ç—Ü", "bitcoin", "btc"],
				"ltc": ["–ª–∞–π—Ç–∫–æ–∏–Ω", "–ª–∞–π—Ç–∫–æ–∏–Ω–∞", "litecoin", "ltc", "–ª—Ç–∫", "ltk"],
				"xmr": ["–º–æ–Ω–µ—Ä–æ", "–º–æ–Ω–µ—Ä–æ", "monero", "xmr", "–º–∞–Ω–µ—Ä–∞", "–º–∞–Ω–µ—Ä—ã"],
				"usdt": ["—é—Å–¥—Ç", "usdt", "tether"],
				"tez": ["—Ç–µ–∑–µ—Ä", "tez", "tezer"]
			}
		
		crypto_found = None
		crypto_text_used = None
		xmr_number = None
		
		# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (—Ç–µ–∑–µ—Ä —Ç—Ä–∞—Å—Ç)
		for crypto_code, keywords in crypto_keywords.items():
			# –î–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–µ–∫—Å—Ç–µ (–¥–æ —É–¥–∞–ª–µ–Ω–∏—è —á–∏—Å–µ–ª)
			original_text_lower = part.lower()
			for kw in keywords:
				if kw in original_text_lower:
					crypto_found = crypto_code.upper()
					crypto_text_used = kw
					# –î–ª—è XMR –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ (–º–æ–Ω–µ—Ä–æ 1, –º–æ–Ω–µ—Ä–æ 2, –º–æ–Ω–µ—Ä–æ 3, –º–∞–Ω–µ—Ä–∞ 1, –º–∞–Ω–µ—Ä–∞ 2, –º–∞–Ω–µ—Ä–∞ 3)
					if crypto_code == "xmr":
						# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞, –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
						if xmr_number_from_part:
							xmr_number = xmr_number_from_part
							logger.debug(f"üîç –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ XMR –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏: {xmr_number}")
						else:
							# –ò—â–µ–º —á–∏—Å–ª–æ –ø–æ—Å–ª–µ "–º–æ–Ω–µ—Ä–æ", "monero", "xmr" –∏–ª–∏ "–º–∞–Ω–µ—Ä–∞"
							xmr_match = re.search(r'(?:–º–æ–Ω–µ—Ä–æ|monero|xmr|–º–∞–Ω–µ—Ä–∞)\s*(\d+)', original_text_lower)
							if xmr_match:
								xmr_number = int(xmr_match.group(1))
								if xmr_number not in [1, 2, 3]:
									xmr_number = None  # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
					break
			if crypto_found:
				break
		
		# –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ç–µ–∫—Å—Ç–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ text_part (–±–µ–∑ —á–∏—Å–µ–ª)
		if not crypto_found:
			for crypto_code, keywords in crypto_keywords.items():
				for kw in keywords:
					if kw in text_part:
						crypto_found = crypto_code.upper()
						crypto_text_used = kw
						break
				if crypto_found:
					break
		
		# –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –∫—Ä–∏–ø—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∫–∞—Ä—Ç—É –∏ –Ω–∞–ª–∏—á–Ω—ã–µ
		if crypto_found:
			# –ï—Å–ª–∏ –≤ —Ç–µ–∫—É—â–µ–º –±–ª–æ–∫–µ —É–∂–µ –µ—Å—Ç—å –∫—Ä–∏–ø—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫ –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
			if "crypto" in current_block and current_block["crypto"]:
				# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫
				if current_block:
					# –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–Ω—ã—Ö, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
					if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) > 1:
						# –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ —Å –ø–µ—Ä–≤—ã–º–∏ –Ω–∞–ª–∏—á–Ω—ã–º–∏
						first_cash = current_block["cash"][0]
						first_block = {k: v for k, v in current_block.items() if k != "cash"}
						first_block["cash"] = first_cash
						result["blocks"].append(first_block)
						
						# –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ —Ç–æ–ª—å–∫–æ —Å –Ω–∞–ª–∏—á–Ω—ã–º–∏
						for cash_item in current_block["cash"][1:]:
							result["blocks"].append({"cash": cash_item})
					else:
						# –ï—Å–ª–∏ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Å–ª–æ–≤–∞—Ä—å
						if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) == 1:
							current_block["cash"] = current_block["cash"][0]
						result["blocks"].append(current_block)
				
				# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –Ω–æ–≤–æ–π –∫—Ä–∏–ø—Ç—ã
				current_block = {}
			
			crypto_data = {
				"currency": crypto_found,
				"amount": amount,
				"original_text": part  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
			}
			# –ï—Å–ª–∏ —ç—Ç–æ XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä
			if crypto_found == "XMR" and xmr_number:
				crypto_data["xmr_number"] = xmr_number
				logger.debug(f"üîç –ù–∞–π–¥–µ–Ω XMR —Å –Ω–æ–º–µ—Ä–æ–º –∫–æ—à–µ–ª—å–∫–∞: {xmr_number}")
			
			current_block["crypto"] = crypto_data
			# –£–±–∏—Ä–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ –∫—Ä–∏–ø—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
			if crypto_text_used:
				text_part = text_part.replace(crypto_text_used, "").strip()
				logger.debug(f"üîç –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∫—Ä–∏–ø—Ç—ã '{crypto_text_used}' –æ—Å—Ç–∞–ª–æ—Å—å: '{text_part}'")
		
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–∞–ª–∏—á–Ω—ã–µ (—Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –ø–æ—Ç–æ–º –±–µ–∑)
		cash_keywords = ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash"]
		has_cash_keyword = any(kw in text_part for kw in cash_keywords)
		
		# –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö (cash_names —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤—ã—à–µ)
		cash_found = None
		for cash_name, keywords in cash_names.items():
			if any(kw in text_part for kw in keywords):
				cash_found = cash_name
				break
		
		# –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞–ª–∏—á–Ω—ã–µ (—Å –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º –∏–ª–∏ –±–µ–∑), –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
		# –ù–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞—Ä—Ç—ã, —Ç–∞–∫ –∫–∞–∫ –≤ –æ–¥–Ω–æ–π —á–∞—Å—Ç–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏ –∫–∞—Ä—Ç–∞, –∏ –Ω–∞–ª–∏—á–Ω—ã–µ
		if cash_found:
			if has_cash_keyword:
				# –£–±–∏—Ä–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –Ω–∞–ª–∏—á–Ω—ã—Ö
				for kw in cash_keywords:
					text_part = text_part.replace(kw, "").strip()
			
			# –£–±–∏—Ä–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
			for cash_name, keywords in cash_names.items():
				if cash_name == cash_found:
					for kw in keywords:
						if kw in text_part:
							text_part = text_part.replace(kw, "").strip()
							break
			
			if "cash" not in current_block:
				current_block["cash"] = []
			current_block["cash"].append({
				"name": cash_found,
				"amount": amount,
				"original_text": part  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
			})
			logger.debug(f"üîç –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–ª–∏—á–Ω—ã—Ö '{cash_found}' –æ—Å—Ç–∞–ª–æ—Å—å: '{text_part}'")
		
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É (—Ñ–æ—Ä–º–∞—Ç: "–≥—Ä—É–ø–ø–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–∞—Ä—Ç—ã —Å—É–º–º–∞" –∏–ª–∏ "–∫–∞—Ä—Ç–∞ –≥—Ä—É–ø–ø–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–∞—Ä—Ç—ã —Å—É–º–º–∞")
		# –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ —É–∂–µ –Ω–∞–π–¥–µ–Ω–∞ –∫—Ä–∏–ø—Ç–∞ (–∫—Ä–∏–ø—Ç–∞ –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
		# –¢–∞–∫–∂–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ—Ö–æ–∂ –Ω–∞ –∫—Ä–∏–ø—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "tezer trust")
		words = text_part.split()
		logger.debug(f"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ä—Ç—ã: text_part='{text_part}', words={words}")
		
		# –ï—Å–ª–∏ —É–∂–µ –Ω–∞–π–¥–µ–Ω–∞ –∫—Ä–∏–ø—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞—Ä—Ç—ã
		if crypto_found:
			logger.debug(f"üîç –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—Ä—Ç—ã: —É–∂–µ –Ω–∞–π–¥–µ–Ω–∞ –∫—Ä–∏–ø—Ç–∞ {crypto_found}")
		else:
			# –£–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ "–∫–∞—Ä—Ç–∞" –∏–∑ –Ω–∞—á–∞–ª–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å (—ç—Ç–æ —É–∫–∞–∑–∞–Ω–∏–µ —Ç–∏–ø–∞, –∞ –Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã)
			if words and words[0].lower() in ["–∫–∞—Ä—Ç–∞", "–∫–∞—Ä—Ç—ã", "card", "cards"]:
				words = words[1:]
				logger.debug(f"üîç –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è '–∫–∞—Ä—Ç–∞' –∏–∑ –Ω–∞—á–∞–ª–∞: words={words}")
			
			# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª–æ–≤ –¥–ª—è –∫–∞—Ä—Ç—ã (–º–∏–Ω–∏–º—É–º 2 —Å–ª–æ–≤–∞: –≥—Ä—É–ø–ø–∞ + –Ω–∞–∑–≤–∞–Ω–∏–µ)
			if len(words) >= 2:
				# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ - –≥—Ä—É–ø–ø–∞, –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
				group_name = words[0].upper()
				card_name = " ".join(words[1:]).upper()
				
				logger.debug(f"üîç –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Ä—Ç—ã: –≥—Ä—É–ø–ø–∞='{group_name}', –Ω–∞–∑–≤–∞–Ω–∏–µ='{card_name}', —á–∞—Å—Ç—å='{part}', text_part='{text_part}'")
				
				# –ï—Å–ª–∏ –≤ —Ç–µ–∫—É—â–µ–º –±–ª–æ–∫–µ —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫ –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
				if "card" in current_block and current_block["card"]:
					# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫
					if current_block:
						# –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–Ω—ã—Ö, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
						if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) > 1:
							# –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ —Å –ø–µ—Ä–≤—ã–º–∏ –Ω–∞–ª–∏—á–Ω—ã–º–∏
							first_cash = current_block["cash"][0]
							first_block = {k: v for k, v in current_block.items() if k != "cash"}
							first_block["cash"] = first_cash
							result["blocks"].append(first_block)
							
							# –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ —Ç–æ–ª—å–∫–æ —Å –Ω–∞–ª–∏—á–Ω—ã–º–∏
							for cash_item in current_block["cash"][1:]:
								result["blocks"].append({"cash": cash_item})
						else:
							# –ï—Å–ª–∏ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Å–ª–æ–≤–∞—Ä—å
							if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) == 1:
								current_block["cash"] = current_block["cash"][0]
							result["blocks"].append(current_block)
					
					# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã
					current_block = {}
			
				# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä—Ç—É
				current_block["card"] = {
					"group": group_name,
					"name": card_name,
					"amount": amount,
					"original_text": part  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
				}
				
				# –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º original_text –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö
				if "cash" in current_block and isinstance(current_block["cash"], list):
					for cash_item in current_block["cash"]:
						if "original_text" not in cash_item:
							cash_item["original_text"] = part
	
	# –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â–µ–º –±–ª–æ–∫–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
	if current_block:
		# –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–Ω—ã—Ö, —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
		if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) > 1:
			# –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ —Å –ø–µ—Ä–≤—ã–º–∏ –Ω–∞–ª–∏—á–Ω—ã–º–∏
			first_cash = current_block["cash"][0]
			first_block = {k: v for k, v in current_block.items() if k != "cash"}
			first_block["cash"] = first_cash
			result["blocks"].append(first_block)
			
			# –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ —Ç–æ–ª—å–∫–æ —Å –Ω–∞–ª–∏—á–Ω—ã–º–∏
			for cash_item in current_block["cash"][1:]:
				result["blocks"].append({"cash": cash_item})
		else:
			# –ï—Å–ª–∏ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Å–ª–æ–≤–∞—Ä—å
			if "cash" in current_block and isinstance(current_block["cash"], list) and len(current_block["cash"]) == 1:
				current_block["cash"] = current_block["cash"][0]
			result["blocks"].append(current_block)
	
	return result


async def find_crypto_by_name(crypto_name: str, db, original_text: Optional[str] = None) -> Optional[str]:
	"""
	–ù–∞—Ö–æ–¥–∏—Ç –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é.
	–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
	
	Args:
		crypto_name: –ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã (BTC, –±–∏—Ç–∫–æ–∏–Ω, –±–∏—Ç–æ–∫ –∏ —Ç.–¥.)
		db: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
		original_text: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π)
		
	Returns:
		–ö–æ–¥ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã (BTC, LTC, XMR, USDT, TEZ, TEZ_TRUST) –∏–ª–∏ None
	"""
	logger.debug(f"üîç –ü–æ–∏—Å–∫ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã: –Ω–∞–∑–≤–∞–Ω–∏–µ='{crypto_name}', –æ—Ä–∏–≥–∏–Ω–∞–ª='{original_text}'")
	
	# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
	if original_text:
		mapping = await db.get_voice_mapping("crypto", original_text.lower())
		if not mapping:
			# –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ —á–∏—Å–µ–ª)
			normalized_text = re.sub(r'\d+(?:\.\d+)?', '', original_text.lower()).strip()
			if normalized_text:
				mapping = await db.get_voice_mapping("crypto", normalized_text)
		
		if mapping and mapping.get("target_name"):
			crypto_type = mapping["target_name"]
			# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–∫–∞—è –∫—Ä–∏–ø—Ç–∞ –µ—Å—Ç—å –≤ –±–∞–∑–µ
			crypto_columns = await db.list_crypto_columns()
			for crypto in crypto_columns:
				if crypto["crypto_type"].upper() == crypto_type.upper():
					logger.debug(f"‚úÖ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é: {crypto_type}")
					return crypto["crypto_type"]
	
	crypto_columns = await db.list_crypto_columns()
	
	# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏–∑ –ë–î (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
	crypto_name_upper = crypto_name.upper()
	# –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º: –∑–∞–º–µ–Ω—è–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–∏—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
	crypto_name_normalized = crypto_name_upper.replace("_", "-")
	
	for crypto in crypto_columns:
		crypto_type_db = crypto["crypto_type"]
		crypto_type_db_upper = crypto_type_db.upper()
		crypto_type_db_normalized = crypto_type_db_upper.replace("_", "-")
		
		# –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (—Å —É—á–µ—Ç–æ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–µ—Ñ–∏—Å/–ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
		if crypto_name_upper == crypto_type_db_upper or crypto_name_normalized == crypto_type_db_normalized:
			logger.debug(f"‚úÖ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é: {crypto_type_db}")
			return crypto_type_db
	
	# –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
	crypto_map = await db.get_crypto_keywords()
	# –ï—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
	if not crypto_map:
		crypto_map = {
			"tez_trust": ["—Ç–µ–∑–µ—Ä —Ç—Ä–∞—Å—Ç", "—Ç–µ–∑–µ—Ä—Ç—Ä–∞—Å—Ç", "tez trust", "teztrust"],
			"btc": ["–±–∏—Ç–æ–∫", "–±—Ç—Ü", "–±–∏—Ç–∫–æ–∏–Ω", "bitcoin", "btc"],
			"ltc": ["–ª–∞–π—Ç–∫–æ–∏–Ω", "litecoin", "ltc", "–ª—Ç–∫", "ltk"],
			"xmr": ["–º–æ–Ω–µ—Ä–æ", "monero", "xmr", "–º–∞–Ω–µ—Ä–∞"],
			"usdt": ["—é—Å–¥—Ç", "usdt", "tether"],
			"tez": ["—Ç–µ–∑–µ—Ä"]
		}
	
	crypto_name_lower = crypto_name.lower()
	
	# –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–ø–ø–∏–Ω–≥
	for code, keywords in crypto_map.items():
		if any(kw in crypto_name_lower for kw in keywords):
			# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–∫–∞—è –∫—Ä–∏–ø—Ç–∞ –µ—Å—Ç—å –≤ –±–∞–∑–µ
			for crypto in crypto_columns:
				if crypto["crypto_type"].upper() == code.upper():
					logger.debug(f"‚úÖ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –º–∞–ø–ø–∏–Ω–≥—É: {crypto['crypto_type']}")
					return crypto["crypto_type"]
			# –ï—Å–ª–∏ –∫—Ä–∏–ø—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ, –Ω–æ –Ω–∞–π–¥–µ–Ω–∞ –≤ –º–∞–ø–ø–∏–Ω–≥–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–¥ –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞
			# –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–∞–∂–µ –µ—Å–ª–∏ –∫—Ä–∏–ø—Ç–∞ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∞–∑—É
			# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –µ—ë —á–µ—Ä–µ–∑ –æ–±—É—á–µ–Ω–∏–µ
			crypto_code_upper = code.upper()
			# –î–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
			if crypto_code_upper == "TEZ_TRUST":
				crypto_code_upper = "TEZ_TRUST"
			elif crypto_code_upper == "TEZ":
				crypto_code_upper = "TEZ"
			logger.debug(f"‚úÖ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –º–∞–ø–ø–∏–Ω–≥—É (–Ω–µ –≤ –±–∞–∑–µ): {crypto_code_upper}")
			return crypto_code_upper
	
	logger.warning(f"‚ö†Ô∏è –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ='{crypto_name}'")
	return None


async def find_card_by_group_and_name(group_name: str, card_name: str, db, original_text: Optional[str] = None) -> Optional[Dict[str, Any]]:
	"""
	–ù–∞—Ö–æ–¥–∏—Ç –∫–∞—Ä—Ç—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≥—Ä—É–ø–ø—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–∞—Ä—Ç—ã.
	–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
	
	Args:
		group_name: –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∫–∞—Ä—Ç
		card_name: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
		db: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
		original_text: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π)
		
	Returns:
		–°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–∞—Ä—Ç–µ –∏–ª–∏ None
	"""
	logger.debug(f"üîç –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç—ã: –≥—Ä—É–ø–ø–∞='{group_name}', –Ω–∞–∑–≤–∞–Ω–∏–µ='{card_name}', –æ—Ä–∏–≥–∏–Ω–∞–ª='{original_text}'")
	
	# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
	if original_text:
		# –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Ç–æ—á–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É
		mapping = await db.get_voice_mapping("card", original_text.lower())
		if not mapping:
			# –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ —Å–ª–æ–≤–∞ "–∫–∞—Ä—Ç–∞" –∏ –±–µ–∑ —á–∏—Å–µ–ª)
			normalized_text = original_text.lower()
			# –£–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ "–∫–∞—Ä—Ç–∞" –≤ –Ω–∞—á–∞–ª–µ
			for word in ["–∫–∞—Ä—Ç–∞", "–∫–∞—Ä—Ç—ã", "card", "cards"]:
				if normalized_text.startswith(word + " "):
					normalized_text = normalized_text[len(word):].strip()
			# –£–±–∏—Ä–∞–µ–º —á–∏—Å–ª–∞
			normalized_text = re.sub(r'\d+(?:\.\d+)?', '', normalized_text).strip()
			if normalized_text:
				mapping = await db.get_voice_mapping("card", normalized_text)
		
		if mapping and mapping.get("target_id"):
			card = await db.get_card_by_id(mapping["target_id"])
			if card:
				logger.debug(f"‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é: {card['name']}")
				return {
					"card_id": card["card_id"],
					"card_name": card["name"],
					"group_id": card.get("group_id")
				}
	
	# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã
	groups = await db.list_card_groups()
	logger.debug(f"üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∫–∞—Ä—Ç: {[g['name'] for g in groups]}")
	
	# –ò—â–µ–º –≥—Ä—É–ø–ø—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞, –≤–∫–ª—é—á–∞—è —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
	group_id = None
	group_name_upper = group_name.upper()
	
	# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –µ–¥–∏–Ω–æ–º—É –≤–∏–¥—É)
	def normalize_group_name(name: str) -> str:
		normalized = name.replace(" ", "").replace("-", "").replace("_", "").upper()
		return normalized
	
	group_name_normalized = normalize_group_name(group_name_upper)
	
	for group in groups:
		group_db_name_upper = group["name"].upper()
		group_db_name_normalized = normalize_group_name(group_db_name_upper)
		
		# –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
		if group_db_name_upper == group_name_upper:
			group_id = group["id"]
			logger.debug(f"‚úÖ –ì—Ä—É–ø–ø–∞ –Ω–∞–π–¥–µ–Ω–∞ (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): '{group['name']}' (id={group_id})")
			break
		
		# –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
		if group_name_normalized == group_db_name_normalized:
			group_id = group["id"]
			logger.debug(f"‚úÖ –ì—Ä—É–ø–ø–∞ –Ω–∞–π–¥–µ–Ω–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): '{group['name']}' (id={group_id})")
			break
		
		# –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–æ–¥–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥—Ä—É–≥–æ–µ)
		if group_name_upper in group_db_name_upper or group_db_name_upper in group_name_upper:
			group_id = group["id"]
			logger.debug(f"‚úÖ –ì—Ä—É–ø–ø–∞ –Ω–∞–π–¥–µ–Ω–∞ (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): '{group['name']}' (id={group_id})")
			break
		
		# –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
		if group_name_normalized in group_db_name_normalized or group_db_name_normalized in group_name_normalized:
			group_id = group["id"]
			logger.debug(f"‚úÖ –ì—Ä—É–ø–ø–∞ –Ω–∞–π–¥–µ–Ω–∞ (—á–∞—Å—Ç–∏—á–Ω–æ–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): '{group['name']}' (id={group_id})")
			break
	
	# –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç—É –±–µ–∑ –≥—Ä—É–ø–ø—ã
	if group_id is None:
		cards = await db.get_cards_without_group()
	else:
		cards = await db.get_cards_by_group(group_id)
	
	# –ò—â–µ–º –∫–∞—Ä—Ç—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞, –≤–∫–ª—é—á–∞—è —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
	card_name_upper = card_name.upper()
	logger.debug(f"üîç –ò—â–µ–º –∫–∞—Ä—Ç—É —Å—Ä–µ–¥–∏ {len(cards)} –∫–∞—Ä—Ç –≤ –≥—Ä—É–ø–ø–µ {group_id}")
	
	# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è (—É–±–∏—Ä–∞–µ–º —Å–∫–æ–±–∫–∏, –ø—Ä–æ–±–µ–ª—ã, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã)
	def normalize_card_name(name: str) -> str:
		# –£–±–∏—Ä–∞–µ–º —Å–∫–æ–±–∫–∏ –∏ –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã
		normalized = re.sub(r'\([^)]*\)', '', name)  # –£–±–∏—Ä–∞–µ–º —Å–∫–æ–±–∫–∏ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
		normalized = normalized.replace(" ", "").replace("-", "").replace("_", "")
		return normalized
	
	# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —á–∞—Å—Ç–µ–π –Ω–∞–∑–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–í–≠–ë" –∏–∑ "–ë–µ–ª–í—ç–±" –∏–ª–∏ "–í–≠–ë –ñ")
	def extract_key_parts(name: str) -> set:
		"""–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —á–∞—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è"""
		parts = set()
		name_upper = name.upper()
		# –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
		parts.add(name_upper)
		# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
		parts.add(normalize_card_name(name_upper))
		# –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ª–æ–≤–∞ (—Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏–ª–∏ –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏)
		# –ù–∞–ø—Ä–∏–º–µ—Ä, "–ë–µ–ª–í—ç–±" -> ["–ë–ï–õ", "–í–≠–ë"], "–í–≠–ë –ñ" -> ["–í–≠–ë", "–ñ"]
		words = re.findall(r'[–ê-–Ø–ÅA-Z]+', name_upper)
		for word in words:
			if len(word) >= 2:  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –±—É–∫–≤—ã
				parts.add(word)
		# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏–∑ 2-3 —Å–∏–º–≤–æ–ª–æ–≤
		if len(name_upper) >= 3:
			for i in range(len(name_upper) - 1):
				part = name_upper[i:i+3]
				if len(part) >= 2:
					parts.add(part)
		return parts
	
	card_name_normalized = normalize_card_name(card_name_upper)
	card_name_parts = extract_key_parts(card_name_upper)
	
	# –°–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –±–æ–ª–µ–µ —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
	candidates = []
	
	for card_id, card_name_db, _ in cards:
		card_name_db_upper = card_name_db.upper()
		card_name_db_normalized = normalize_card_name(card_name_db_upper)
		logger.debug(f"üîç –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º: '{card_name_upper}' (–Ω–æ—Ä–º: '{card_name_normalized}') —Å '{card_name_db_upper}' (–Ω–æ—Ä–º: '{card_name_db_normalized}')")
		
		# –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
		if card_name_db_upper == card_name_upper:
			card = await db.get_card_by_id(card_id)
			if card:
				logger.debug(f"‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): {card_name_db}")
				return {
					"card_id": card_id,
					"card_name": card_name_db,
					"group_id": group_id
				}
		
		# –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π (–±–µ–∑ —Å–∫–æ–±–æ–∫, –ø—Ä–æ–±–µ–ª–æ–≤, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)
		if card_name_normalized == card_name_db_normalized:
			card = await db.get_card_by_id(card_id)
			if card:
				logger.debug(f"‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): {card_name_db}")
				return {
					"card_id": card_id,
					"card_name": card_name_db,
					"group_id": group_id
				}
		
		# –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —á–∞—Å—Ç—è–º
		card_name_db_parts = extract_key_parts(card_name_db_upper)
		common_parts = card_name_parts & card_name_db_parts
		if common_parts:
			# –í—ã—á–∏—Å–ª—è–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö —á–∞—Å—Ç–µ–π
			similarity = len(common_parts) / max(len(card_name_parts), len(card_name_db_parts), 1)
			# –û—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω—ã –æ–±—â–∏–µ —á–∞—Å—Ç–∏ –¥–ª–∏–Ω–æ–π >= 3 —Å–∏–º–≤–æ–ª–æ–≤
			important_common = {p for p in common_parts if len(p) >= 3}
			if important_common:
				candidates.append((card_id, card_name_db, similarity, len(important_common)))
		
		# –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
		if card_name_normalized in card_name_db_normalized or card_name_db_normalized in card_name_normalized:
			# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–Ω–∞—á–∏–º–æ–µ (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)
			common_chars = set(card_name_normalized) & set(card_name_db_normalized)
			if len(common_chars) >= 3:
				card = await db.get_card_by_id(card_id)
				if card:
					logger.debug(f"‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ (—á–∞—Å—Ç–∏—á–Ω–æ–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): {card_name_db}")
					return {
						"card_id": card_id,
						"card_name": card_name_db,
						"group_id": group_id
					}
		
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
		if len(card_name_normalized) >= 3 and len(card_name_db_normalized) >= 3:
			if card_name_normalized in card_name_db_normalized or card_name_db_normalized in card_name_normalized:
				# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—â–∞—è —á–∞—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–Ω–∞—á–∏–º–∞—è
				min_len = min(len(card_name_normalized), len(card_name_db_normalized))
				if min_len >= 3:
					card = await db.get_card_by_id(card_id)
					if card:
						logger.debug(f"‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ (–æ–±—Ä–∞—Ç–Ω–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö): {card_name_db}")
						return {
							"card_id": card_id,
							"card_name": card_name_db,
							"group_id": group_id
						}
		
		# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π (3-4 —Å–∏–º–≤–æ–ª–∞)
		# –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –¥–ª–∏–Ω—ã –∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ 1 —Å–∏–º–≤–æ–ª, —Å—á–∏—Ç–∞–µ–º –∏—Ö –ø–æ—Ö–æ–∂–∏–º–∏
		if len(card_name_normalized) >= 3 and len(card_name_normalized) <= 4:
			if len(card_name_normalized) == len(card_name_db_normalized):
				# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö
				matching_chars = sum(1 for i in range(len(card_name_normalized)) 
				                     if i < len(card_name_db_normalized) and card_name_normalized[i] == card_name_db_normalized[i])
				# –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –º–∏–Ω–∏–º—É–º 2 –∏–∑ 3 —Å–∏–º–≤–æ–ª–æ–≤ –∏–ª–∏ 3 –∏–∑ 4, —Å—á–∏—Ç–∞–µ–º –ø–æ—Ö–æ–∂–∏–º–∏
				similarity_threshold = len(card_name_normalized) - 1
				if matching_chars >= similarity_threshold:
					card = await db.get_card_by_id(card_id)
					if card:
						logger.debug(f"‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ (–ø–æ—Ö–æ–∂–µ—Å—Ç—å –∫–æ—Ä–æ—Ç–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π: {matching_chars}/{len(card_name_normalized)} —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö): {card_name_db}")
						return {
							"card_id": card_id,
							"card_name": card_name_db,
							"group_id": group_id
						}
	
	# –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å –æ–±—â–∏–º–∏ —á–∞—Å—Ç—è–º–∏, –≤—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π
	if candidates:
		# –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–∞–∂–Ω—ã—Ö –æ–±—â–∏—Ö —á–∞—Å—Ç–µ–π (>= 3 —Å–∏–º–≤–æ–ª–æ–≤), –∑–∞—Ç–µ–º –ø–æ –æ–±—â–µ–π —Å—Ö–æ–∂–µ—Å—Ç–∏
		candidates.sort(key=lambda x: (x[3], x[2]), reverse=True)
		best_candidate = candidates[0]
		card_id, card_name_db, similarity, important_count = best_candidate
		# –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –≤–∞–∂–Ω–∞—è –æ–±—â–∞—è —á–∞—Å—Ç—å (>= 3 —Å–∏–º–≤–æ–ª–æ–≤), –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç
		if important_count > 0:
			card = await db.get_card_by_id(card_id)
			if card:
				logger.info(f"‚úÖ –ö–∞—Ä—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ —Å—Ö–æ–∂–µ—Å—Ç–∏ —á–∞—Å—Ç–µ–π (–≤–∞–∂–Ω—ã—Ö —á–∞—Å—Ç–µ–π: {important_count}, —Å—Ö–æ–∂–µ—Å—Ç—å: {similarity:.2f}): '{card_name}' -> '{card_name_db}'")
				return {
					"card_id": card_id,
					"card_name": card_name_db,
					"group_id": group_id
				}
	
	logger.warning(f"‚ö†Ô∏è –ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: –≥—Ä—É–ø–ø–∞='{group_name}', –Ω–∞–∑–≤–∞–Ω–∏–µ='{card_name}'")
	return None


async def find_cash_by_name(cash_name: str, db, original_text: Optional[str] = None) -> Optional[Dict[str, Any]]:
	"""
	–ù–∞—Ö–æ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é.
	–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
	
	Args:
		cash_name: –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ª–∏—á–Ω—ã—Ö (–±–µ–ª–∫–∏, —é—Å–¥, –±–∞–∫—Å—ã –∏ —Ç.–¥.)
		db: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
		original_text: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π)
		
	Returns:
		–°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–∞–ª–∏—á–Ω—ã—Ö –∏–ª–∏ None
	"""
	if not cash_name:
		logger.warning(f"‚ö†Ô∏è find_cash_by_name: cash_name –ø—É—Å—Ç–æ–µ –∏–ª–∏ None")
		return None
	
	logger.debug(f"üîç –ü–æ–∏—Å–∫ –Ω–∞–ª–∏—á–Ω—ã—Ö: –Ω–∞–∑–≤–∞–Ω–∏–µ='{cash_name}', –æ—Ä–∏–≥–∏–Ω–∞–ª='{original_text}'")
	
	# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
	if original_text:
		# –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Ç–æ—á–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É
		mapping = await db.get_voice_mapping("cash", original_text.lower())
		if not mapping:
			# –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ "–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash" –∏ –±–µ–∑ —á–∏—Å–µ–ª)
			normalized_text = original_text.lower()
			# –£–±–∏—Ä–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
			for word in ["–Ω–∞–ª–∏—á–Ω—ã–µ", "–Ω–∞–ª", "cash"]:
				normalized_text = normalized_text.replace(word, "").strip()
			# –£–±–∏—Ä–∞–µ–º —á–∏—Å–ª–∞
			normalized_text = re.sub(r'\d+(?:\.\d+)?', '', normalized_text).strip()
			if normalized_text:
				mapping = await db.get_voice_mapping("cash", normalized_text)
		
		if mapping and mapping.get("target_name"):
			cash_columns = await db.list_cash_columns()
			for cash in cash_columns:
				if cash["cash_name"] == mapping["target_name"]:
					logger.debug(f"‚úÖ –ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é: {cash['cash_name']}")
					return cash
	
	cash_columns = await db.list_cash_columns()
	
	# –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏–π
	cash_map = {
		"–±–µ–ª–∫–∏": ["–±–µ–ª–∫–∏", "–±–µ–ª–∫–∞", "squirrel"],
		"—é—Å–¥": ["—é—Å–¥", "usd", "–±–∞–∫—Å—ã", "–±–∞–∫—Å", "–¥–æ–ª–ª–∞—Ä", "–¥–æ–ª–ª–∞—Ä—ã", "dollar", "dollars"],
		"—Ä—É–±": ["—Ä—É–±", "—Ä—É–±–ª—å", "—Ä—É–±–ª–∏", "rub", "ruble"]
	}
	
	cash_name_lower = cash_name.lower()
	
	# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –Ω–∞–ª–∏—á–Ω—ã—Ö
	cash_type = None
	for cash_key, keywords in cash_map.items():
		if any(kw in cash_name_lower for kw in keywords):
			cash_type = cash_key
			break
	
	if not cash_type:
		return None
	
	# –ò—â–µ–º –≤ –±–∞–∑–µ –ø–æ display_name –∏–ª–∏ cash_name
	for cash in cash_columns:
		display_name = cash.get("display_name", "") or ""
		cash_name_db = cash.get("cash_name", "") or ""
		
		# –ò—Å–ø–æ–ª—å–∑—É–µ–º display_name, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å, –∏–Ω–∞—á–µ cash_name
		search_text = (display_name if display_name else cash_name_db).lower()
		cash_name_db_lower = cash_name_db.lower()
		
		logger.debug(f"üîç –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –Ω–∞–ª–∏—á–Ω—ã–µ: —Ç–∏–ø='{cash_type}', display='{display_name}', name='{cash_name_db}', search='{search_text}'")
		
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ display_name –∏–ª–∏ cash_name (–Ω–∞–ø—Ä–∏–º–µ—Ä, "üêø" –¥–ª—è –±–µ–ª–æ–∫)
		if cash_type == "–±–µ–ª–∫–∏":
			if "üêø" in display_name or "üêø" in cash_name_db or "–±–µ–ª" in search_text:
				logger.debug(f"‚úÖ –ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã (–±–µ–ª–∫–∏): {cash.get('cash_name')}")
				return cash
		elif cash_type == "—é—Å–¥":
			if "üíµ" in display_name or "üíµ" in cash_name_db or "usd" in search_text or "–¥–æ–ª–ª" in search_text:
				logger.debug(f"‚úÖ –ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã (USD): {cash.get('cash_name')}")
				return cash
		elif cash_type == "—Ä—É–±":
			if "—Ä—É–±" in search_text or "rub" in search_text:
				logger.debug(f"‚úÖ –ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã (RUB): {cash.get('cash_name')}")
				return cash
		
		# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ cash_name (–µ—Å–ª–∏ cash_name —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∏–ø)
		if cash_type in cash_name_db_lower:
			logger.debug(f"‚úÖ –ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã (–ø–æ –∏–º–µ–Ω–∏): {cash.get('cash_name')}")
			return cash
	
	logger.warning(f"‚ö†Ô∏è –ù–∞–ª–∏—á–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: –Ω–∞–∑–≤–∞–Ω–∏–µ='{cash_name}', —Ç–∏–ø='{cash_type}'")
	return None

